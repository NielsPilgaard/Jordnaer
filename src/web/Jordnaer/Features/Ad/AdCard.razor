@inject IPartnerService PartnerService
@inject ILogger<AdCard> Logger

<MudLink Href="@Link" Target="_blank" Underline="Underline.None" OnClick="HandleClickAsync"
    UserAttributes="@(new Dictionary<string, object> { { "rel", "noopener" } })">
    <div class="image-ad-wrapper">
        <div class="image-with-label">
            <MudImage Src="@ImagePath" Alt="@ImageAlt" Class="ad-image"
                Style="width: 100%; height: auto; border-radius: 8px;" loading="lazy" />
            <div class="image-ad-label">Annonce</div>
        </div>
    </div>
</MudLink>

@code {
    [Parameter, EditorRequired]
    public required string Link { get; set; }

    [Parameter, EditorRequired]
    public required string ImagePath { get; set; }

    [Parameter, EditorRequired]
    public required string ImageAlt { get; set; }

    [Parameter]
    public Guid PartnerId { get; set; } = Guid.Empty;

    [Parameter]
    public bool IsPreview { get; set; } = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !IsPreview)
        {
            JordnaerMetrics.AdViewCounter.Add(1, new KeyValuePair<string, object?>("link", Link));

            if (PartnerId != Guid.Empty)
            {
                try
                {
                    await PartnerService.RecordImpressionAsync(PartnerId);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Failed to record impression for partner {PartnerId}", PartnerId);
                }
            }
        }
    }

    private async Task HandleClickAsync()
    {
        if (!IsPreview && PartnerId != Guid.Empty)
        {
            try
            {
                await PartnerService.RecordClickAsync(PartnerId);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to record click for partner {PartnerId}", PartnerId);
            }
        }
    }
}