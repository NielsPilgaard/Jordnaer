@inject IPartnerService PartnerService
@inject ILogger<AdCard> Logger

<MudLink Href="@Link" Target="_blank" Underline="Underline.None" OnClick="HandleClickAsync"
    UserAttributes="@(new Dictionary<string, object> { { "rel", "noopener" } })">
    <div class="image-ad-wrapper">
        <div class="image-with-label">
            <MudImage Src="@ImagePath" Alt="@ImageAlt" Class="ad-image"
                Style="width: 100%; height: auto; border-radius: 8px;" loading="lazy" />
            <div class="image-ad-label" style="@GetLabelStyle()">Annonce</div>
        </div>
    </div>
</MudLink>

@code {
    [Parameter, EditorRequired]
    public required string Link { get; set; }

    [Parameter, EditorRequired]
    public required string ImagePath { get; set; }

    [Parameter, EditorRequired]
    public required string ImageAlt { get; set; }

    [Parameter]
    public Guid PartnerId { get; set; } = Guid.Empty;

    [Parameter]
    public bool IsPreview { get; set; } = false;

    /// <summary>
    /// Optional custom background color for the "Annonce" label (hex format like #FFFFFF).
    /// If not set, uses the default semi-transparent dark background.
    /// </summary>
    [Parameter]
    public string? LabelColor { get; set; }

    private string GetLabelStyle()
    {
        if (string.IsNullOrWhiteSpace(LabelColor))
        {
            return string.Empty;
        }

        // Determine text color based on label background brightness
        var textColor = IsLightColor(LabelColor) ? "rgba(0, 0, 0, 0.7)" : "rgba(255, 255, 255, 0.9)";
        return $"background-color: {LabelColor}; color: {textColor};";
    }

    private static bool IsLightColor(string hexColor)
    {
        // Parse hex color and calculate perceived brightness
        if (hexColor.StartsWith('#') && hexColor.Length == 7)
        {
            var r = Convert.ToInt32(hexColor.Substring(1, 2), 16);
            var g = Convert.ToInt32(hexColor.Substring(3, 2), 16);
            var b = Convert.ToInt32(hexColor.Substring(5, 2), 16);
            // Using perceived brightness formula
            var brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128;
        }
        return false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !IsPreview)
        {
            JordnaerMetrics.AdViewCounter.Add(1, new KeyValuePair<string, object?>("link", Link));

            if (PartnerId != Guid.Empty)
            {
                try
                {
                    await PartnerService.RecordImpressionAsync(PartnerId);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Failed to record impression for partner {PartnerId}", PartnerId);
                }
            }
        }
    }

    private Task HandleClickAsync()
    {
        if (!IsPreview && PartnerId != Guid.Empty)
        {
            // Fire-and-forget: Don't await since browser navigation cannot be blocked
            _ = RecordClickInBackgroundAsync();
        }
        return Task.CompletedTask;
    }

    private async Task RecordClickInBackgroundAsync()
    {
        try
        {
            await PartnerService.RecordClickAsync(PartnerId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to record click for partner {PartnerId}", PartnerId);
        }
    }
}