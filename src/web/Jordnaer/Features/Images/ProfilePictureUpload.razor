@using Jordnaer.Shared
@using Microsoft.AspNetCore.Components.Forms
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<div class="profile-picture-upload-container">
    @if (!_showCropper)
    {
        <ProfilePictureUploadButton CurrentProfilePictureUrl="@CurrentProfilePictureUrl"
                                    DisplayInitial="@DisplayInitial"
                                    ProfilePictureAltText="@ProfilePictureAltText"
                                    OnFilesChanged="@OnInputFileChanged" />
    }
    else if (_originalImageDataUrl is not null)
    {
        <ImageCropper ImageDataUrl="@_originalImageDataUrl"
                      ShowWarning="@_showSizeWarning"
                      WarningMessage="@_sizeWarningMessage"
                      IsSaving="@_isSaving"
                      OnSave="@HandleCroppedImageSave"
                      OnCancel="@HandleCancelCrop" />
    }
</div>

@code {
    [Parameter]
    public string? CurrentProfilePictureUrl { get; set; }

    [Parameter]
    public string DisplayName { get; set; } = string.Empty;

    [Parameter]
    public char DisplayInitial { get; set; } = '?';

    [Parameter]
    public string ProfilePictureAltText { get; set; } = "Profilbillede";

    [Parameter]
    public required Func<byte[], Task<string>> OnSave { get; set; }

    [Parameter]
    public EventCallback OnImageChanged { get; set; }

    private bool _showCropper = false;
    private bool _isSaving = false;
    private string? _originalImageDataUrl;
    private string? _contentType;
    private bool _showSizeWarning = false;
    private string _sizeWarningMessage = string.Empty;

    private static readonly BrowserFileValidator BrowserFileValidator = new();
    private static readonly ImageDimensionValidator DimensionValidator = new();

    private async Task OnInputFileChanged(InputFileChangeEventArgs inputFileChange)
    {
        var validationResult = await BrowserFileValidator.ValidateAsync(inputFileChange.File);
        if (!validationResult.IsValid)
        {
            Snackbar.Add(string.Join(" ", validationResult.Errors), Severity.Error);
            return;
        }

        _contentType = inputFileChange.File.ContentType;

        try
        {
            // Read the original image to get dimensions and create data URL
            using var ms = new MemoryStream();
            var maxSize = BrowserFileValidator.MaxFileSize * 2; // Allow larger for initial read
            await inputFileChange.File.OpenReadStream(maxSize).CopyToAsync(ms);
            var bytes = ms.ToArray();
            _originalImageDataUrl = $"data:{_contentType};base64,{Convert.ToBase64String(bytes)}";

            // Check image dimensions and show warnings
            var dimensionArray = await JSRuntime.InvokeAsync<int[]>("imageCropper.getImageDimensions", _originalImageDataUrl);
            if (dimensionArray.Length == 2)
            {
                var dimensions = new ImageDimensions(dimensionArray[0], dimensionArray[1]);
                var dimensionValidation = DimensionValidator.Validate(dimensions);

                _showSizeWarning = dimensionValidation.ShowWarning;
                _sizeWarningMessage = dimensionValidation.WarningMessage;
            }

            _showCropper = true;
            StateHasChanged();
        }
        catch (IOException ex)
        {
            Snackbar.Add($"Der opstod en fejl ved læsning af filen: {ex.Message}", Severity.Error);
        }
        catch (OutOfMemoryException)
        {
            Snackbar.Add("Filen er for stor til at blive behandlet. Prøv venligst med en mindre fil.", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Der opstod en uventet fejl: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleCroppedImageSave(byte[] bytes)
    {
        _isSaving = true;
        StateHasChanged();

        try
        {
            // Call the save callback
            var uri = await OnSave(bytes);

            // Update the display
            CurrentProfilePictureUrl = $"data:{_contentType};base64,{Convert.ToBase64String(bytes)}";

            // Clean up and hide cropper
            _showCropper = false;
            _originalImageDataUrl = null;

            await OnImageChanged.InvokeAsync();

            Snackbar.Add("Billedet er blevet gemt.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Der opstod en fejl ved gemning af billedet: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private Task HandleCancelCrop()
    {
        _showCropper = false;
        _originalImageDataUrl = null;
        StateHasChanged();
        return Task.CompletedTask;
    }
}
