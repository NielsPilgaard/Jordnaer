@using Jordnaer.Features.Ad
@inject IJSRuntime JsRuntime
@inject NavigationManager Navigation

@implements IDisposable

<MudContainer MaxWidth="MaxWidth.Large" Class="px-0">
    <MudGrid Spacing="3" Justify="@(SearchResult.Groups.Count <= 3 ? Justify.Center : Justify.FlexStart)">
        @{
            var items = GetItemsWithAds();
            var index = 0;
        }
        @foreach (var item in items)
        {
            var itemId = GetItemId(index);
            <MudItem xs="12" sm="6" md="4" lg="3" id="@itemId">
                @if (item.IsAd && item.Ad is not null)
                {
                    <AdCard Link="@item.Ad.Link"
                            ImagePath="@item.Ad.ImagePath"
                            ImageAlt="@item.Ad.Title" />
                }
                else if (item.Group is not null)
                {
                    <MudNavLink Class="card-link" Href="@($"/groups/{item.Group.Name}")">
                        <MudCard Class="pa-3 my-3 card-hover" Elevation="3">
                            <MudCardContent Class="d-flex flex-column align-center">
                                <MudTextField Label="Navn"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.AlternateEmail"
                                              ReadOnly
                                              T="string"
                                              Text="@item.Group.Name"
                                              Class="mb-5" />

                                @if (!string.IsNullOrEmpty(item.Group.ProfilePictureUrl))
                                {
                                    <MudImage Fluid
                                              Width="200"
                                              Style="border-radius: 25%"
                                              Src="@item.Group.ProfilePictureUrl"
                                              loading="lazy" />
                                }

                                <MudTextField Label="OmrÃ¥de"
                                              Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Place"
                                              ReadOnly
                                              T="string"
                                              Text="@item.Group.DisplayLocation()"
                                              Class="mb-4" />

                                @if (item.Group.Categories.Length is not 0)
                                {
                                    <div class="d-flex align-center">
                                        <MudIcon Class="mr-1" Icon="@Icons.Material.Filled.Star" />
                                        <MudText Typo="Typo.h6">Kategorier</MudText>
                                    </div>
                                    <MudChipSet ReadOnly Class="d-flex flex-wrap justify-center flex-grow-1" T="MudChip<string>">
                                        @foreach (var category in item.Group.Categories)
                                        {
                                            <MudChip Color="Color.Tertiary">@category</MudChip>
                                        }
                                    </MudChipSet>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudNavLink>
                }
            </MudItem>
            index++;
        }
    </MudGrid>
</MudContainer>
<MudPagination Class="mt-5 d-flex justify-center"
               BoundaryCount="0"
               MiddleCount="3"
               UserAttributes="@(new Dictionary<string, object> {["title"] = $"Viser {Filter.PageSize} ud af {SearchResult.TotalCount} resultater."})"
               SelectedChanged="@SelectedPageChanged"
               Variant="Variant.Filled"
               Count="@(SearchResult.TotalCount / Filter.PageSize)"
               Selected="Filter.PageNumber" />
@code {
    [Parameter]
    public required GroupSearchFilter Filter { get; set; }

    [Parameter]
    public required GroupSearchResult SearchResult { get; set; }

    [Parameter]
    public EventCallback<int> SelectedPageChanged { get; set; }

    private IDisposable? _locationChangingHandler;

    private record SearchResultItem
    {
        public bool IsAd { get; init; }
        public GroupSlim? Group { get; init; }
        public AdData? Ad { get; init; }
    }

    private List<SearchResultItem> GetItemsWithAds()
    {
        var items = new List<SearchResultItem>();

        // Calculate how many ads we need based on results
        // Always show at least 1 ad if there are any results
        var adCount = SearchResult.Groups.Count > 0
            ? Math.Max(1, (int)Math.Ceiling(SearchResult.Groups.Count / 8.0))
            : 0;

        var ads = HardcodedAds.GetAdsForUserSearch(adCount);
        var adIndex = 0;

        // Add groups with ads interspersed
        for (int i = 0; i < SearchResult.Groups.Count; i++)
        {
            items.Add(new SearchResultItem { Group = SearchResult.Groups[i] });

            // Insert ad after every 8th group, or at the end if we have fewer than 8 groups
            var shouldInsertAd = (i + 1) % 8 == 0 || (i == SearchResult.Groups.Count - 1 && adIndex < ads.Count);

            if (shouldInsertAd && adIndex < ads.Count)
            {
                items.Add(new SearchResultItem
                {
                    IsAd = true,
                    Ad = ads[adIndex++]
                });
            }
        }

        return items;
    }

    private string GetItemId(int index) => $"group-search-item-{index}";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RestoreScrollPosition();
        }
    }

    private async Task RestoreScrollPosition()
    {
        await JsRuntime.InvokeVoidAsyncWithErrorHandling("groupSearchScroll.restoreScrollPosition");
    }

    private async Task SaveScrollPosition()
    {
        await JsRuntime.InvokeVoidAsyncWithErrorHandling("groupSearchScroll.saveScrollPosition");
    }

    protected override void OnInitialized()
    {
        _locationChangingHandler = Navigation
            .RegisterLocationChangingHandler(async _ => await SaveScrollPosition());
    }

    public void Dispose()
    {
        _locationChangingHandler?.Dispose();
    }
}
