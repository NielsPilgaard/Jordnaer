@using Jordnaer.Features.Ad
@inject IJSRuntime JsRuntime
@inject NavigationManager Navigation
@inject IAdProvider AdProvider

@implements IDisposable

<MudContainer MaxWidth="MaxWidth.Large" Class="px-0">
    <MudGrid Spacing="3" Justify="@(SearchResult.Groups.Count <= 3 ? Justify.Center : Justify.FlexStart)">
        @{
            var items = GetItemsWithAds();
            var index = 0;
        }
        @foreach (var item in items)
        {
            var itemId = GetItemId(index);
            <MudItem xs="12" sm="6" md="4" lg="3" id="@itemId">
                @if (item.IsAd && item.Ad is not null)
                {
                    <AdCard Link="@item.Ad.Link" ImagePath="@item.Ad.ImagePath" ImageAlt="@item.Ad.Title"
                            PartnerId="@(item.Ad.PartnerId ?? Guid.Empty)" LabelColor="@item.Ad.LabelColor" />
                }
                else if (item.Group is not null)
                {
                    <GroupCard Group="@item.Group" />
                }
            </MudItem>
            index++;
        }
    </MudGrid>
</MudContainer>
<MudPagination Class="mt-5 d-flex justify-center" BoundaryCount="0" MiddleCount="3"
    UserAttributes="@(new Dictionary<string, object> { ["title"] = $"Viser {Filter.PageSize} ud af {SearchResult.TotalCount} resultater." })"
    SelectedChanged="@SelectedPageChanged" Variant="Variant.Filled"
    Count="@((int)Math.Ceiling((double)SearchResult.TotalCount / Filter.PageSize))" Selected="Filter.PageNumber" />
@code {
    [Parameter]
    public required GroupSearchFilter Filter { get; set; }

    [Parameter]
    public required GroupSearchResult SearchResult { get; set; }

    [Parameter]
    public EventCallback<int> SelectedPageChanged { get; set; }

    private IDisposable? _locationChangingHandler;
    private List<AdData> _ads = [];
    private int _lastGroupCount;
    private int _lastPageNumber;

    private record SearchResultItem
    {
        public bool IsAd { get; init; }
        public GroupSlim? Group { get; init; }
        public AdData? Ad { get; init; }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only refresh ads when relevant parameters change
        var currentGroupCount = SearchResult?.Groups?.Count ?? 0;
        var currentPageNumber = Filter?.PageNumber ?? 0;

        if (_lastGroupCount != currentGroupCount || _lastPageNumber != currentPageNumber)
        {
            _lastGroupCount = currentGroupCount;
            _lastPageNumber = currentPageNumber;
            await RefreshAdsAsync();
        }
    }

    private async Task RefreshAdsAsync()
    {
        var adCount = SearchResult?.Groups?.Count > 0 ? 1 : 0;
        var result = await AdProvider.GetAdsAsync(adCount);

        _ads = result.Match(
            ads => ads,
            error => new List<AdData>() // Silently use empty list on error - ads are non-critical
        );
    }

    private List<SearchResultItem> GetItemsWithAds()
    {
        var items = new List<SearchResultItem>();

        if (_ads.Count == 0 || SearchResult.Groups.Count == 0)
        {
            // No ads or no groups, just return groups
            items.AddRange(SearchResult.Groups.Select(g => new SearchResultItem { Group = g }));
            return items;
        }

        // Random placement for the ad among the first 12 items (or fewer if less results)
        var maxItems = Math.Min(SearchResult.Groups.Count + 1, 12); // +1 to account for the ad
        var adPosition = Random.Shared.Next(0, maxItems);

        var groupIndex = 0;
        for (int i = 0; i < maxItems; i++)
        {
            if (i == adPosition)
            {
                items.Add(new SearchResultItem { IsAd = true, Ad = _ads[0] });
            }
            else if (groupIndex < SearchResult.Groups.Count)
            {
                items.Add(new SearchResultItem { Group = SearchResult.Groups[groupIndex] });
                groupIndex++;
            }
        }

        return items;
    }

    private string GetItemId(int index) => $"group-search-item-{index}";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RestoreScrollPosition();
        }
    }

    private async Task RestoreScrollPosition()
    {
        await JsRuntime.InvokeVoidAsyncWithErrorHandling("groupSearchScroll.restoreScrollPosition");
    }

    private async Task SaveScrollPosition()
    {
        await JsRuntime.InvokeVoidAsyncWithErrorHandling("groupSearchScroll.saveScrollPosition");
    }

    protected override void OnInitialized()
    {
        _locationChangingHandler = Navigation
        .RegisterLocationChangingHandler(async _ => await SaveScrollPosition());
    }

    public void Dispose()
    {
        _locationChangingHandler?.Dispose();
    }
}