@using Jordnaer.Features.Map
@using Microsoft.FeatureManagement
@using MudBlazor
@using Variant = MudBlazor.Variant
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime
@inject IFeatureManager FeatureManager

<MudContainer MaxWidth="MaxWidth.Medium">
	<BackButton Href="/groups" />

	<MudPaper Elevation="3" Class="pa-6 pa-sm-8 pa-md-10 mt-5">
		<EditForm OnValidSubmit="@OnValidSubmit" Model="Filter">
			<DataAnnotationsValidator />

			<MudGrid Justify="Justify.SpaceAround" Spacing="6">

				@if (_mapSearchEnabled)
				{
					@* New map-based search experience *@
					<MudItem xs="12">
						<MapSearchFilter @ref="_mapSearchFilter" RadiusKm="@(Filter.WithinRadiusKilometers ?? 10)"
							RadiusKmChanged="OnRadiusChanged" OnLocationSearchChanged="OnLocationSearchChanged"
							Groups="@_groupMarkers" />
					</MudItem>
				}
				else
				{
					@* Existing zip code search *@
					<MudItem xs="8">
						<ZipCodeAutoComplete For="() => Filter.Location" Location="@Filter.Location"
							LocationChanged="LocationChanged" DisableSmartCompletion="_disableSmartCompletionForZipCode" />
					</MudItem>
					<MudItem xs="4">
						<MudNumericField For="() => Filter.WithinRadiusKilometers"
							@bind-Value="Filter.WithinRadiusKilometers" Label="km" Placeholder="Radius">
						</MudNumericField>
					</MudItem>
				}

				<MudItem xs="12">
					<CategorySelector @bind-Categories="Filter.Categories" />
				</MudItem>

				<MudItem xs="12">
					<MudTextField @bind-Value="Filter.Name" Placeholder="Gruppenavn" Label="Søg på navn" Clearable
						Variant="Variant.Outlined" Adornment="Adornment.Start"
						AdornmentIcon="@Icons.Material.Filled.Group" AdornmentColor="Color.Primary" />
				</MudItem>

				<MudItem xs="12" Class="mt-6">

					<MudButtonGroup OverrideStyles="false" Style="width: 100%;">
						<MudButton FullWidth Variant="Variant.Filled" Color="Color.Success"
							ButtonType="ButtonType.Submit" Size="Size.Large"
							StartIcon="@Icons.Material.Filled.Search">
							Søg
						</MudButton>
						<MudButton OnClick="ClearFilter" Color="Color.Default" Variant="Variant.Outlined"
							ButtonType="ButtonType.Reset" Size="Size.Large"
							StartIcon="@Icons.Material.Filled.Clear">
							Ryd
						</MudButton>
					</MudButtonGroup>

				</MudItem>
			</MudGrid>
		</EditForm>
	</MudPaper>
</MudContainer>

@code
{
	private MapSearchFilter? _mapSearchFilter;
	private bool _mapSearchEnabled = false;

	[Parameter]
	public required GroupSearchFilter Filter { get; set; }

	[Parameter]
	public EventCallback<GroupSearchFilter> FilterChanged { get; set; }

	[Parameter]
	public required EventCallback OnValidSubmit { get; set; }

	/// <summary>
	/// Groups to display as markers on the map
	/// </summary>
	[Parameter]
	public IEnumerable<GroupSlim>? Groups { get; set; }

	private static readonly GroupSearchFilter DefaultFilter = new();

	private bool _recentlyClearedForm = false;
	private bool _disableSmartCompletionForZipCode => _recentlyClearedForm || Filter != DefaultFilter;

	private List<GroupMarkerData>? _groupMarkers;
	private IEnumerable<GroupSlim>? _previousGroups;

	protected override void OnParametersSet()
	{
		// Early return if Groups reference hasn't changed
		if (ReferenceEquals(Groups, _previousGroups))
		{
			return;
		}

		// Convert GroupSlim to GroupMarkerData for the map and materialize
		_groupMarkers = Groups?
			.Where(g => g.Latitude.HasValue && g.Longitude.HasValue)
			.Select(g => new GroupMarkerData
			{
				Id = g.Id,
				Name = g.Name,
				ProfilePictureUrl = g.ProfilePictureUrl,
				WebsiteUrl = g.WebsiteUrl,
				ShortDescription = g.ShortDescription,
				ZipCode = g.ZipCode,
				City = g.City,
				Latitude = g.Latitude!.Value,
				Longitude = g.Longitude!.Value
			})
			.ToList();

		_previousGroups = Groups;
	}

	protected override async Task OnInitializedAsync()
	{
		_mapSearchEnabled = await FeatureManager.IsEnabledAsync(FeatureFlags.MapSearch);
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender && _mapSearchEnabled && _mapSearchFilter is not null)
		{
			// If we have lat/long in the filter from query string, set the map location
			if (Filter.Latitude.HasValue && Filter.Longitude.HasValue && Filter.WithinRadiusKilometers.HasValue)
			{
				await _mapSearchFilter.SetLocationAsync(
				Filter.Latitude.Value,
				Filter.Longitude.Value,
				13);
			}
		}
	}

	private async Task OnLocationSearchChanged((double Latitude, double Longitude, int RadiusKm, string? Address)
	locationSearch)
	{
		Filter.Latitude = locationSearch.Latitude;
		Filter.Longitude = locationSearch.Longitude;
		Filter.WithinRadiusKilometers = locationSearch.RadiusKm;
		Filter.Location = locationSearch.Address;

		await FilterChanged.InvokeAsync(Filter);
	}

	private async Task OnRadiusChanged(int newRadius)
	{
		Filter.WithinRadiusKilometers = newRadius;

		// Update the map if we have a location
		if (_mapSearchFilter is not null && Filter.Latitude.HasValue && Filter.Longitude.HasValue)
		{
			await _mapSearchFilter.UpdateSearchRadiusAsync(
			Filter.Latitude.Value,
			Filter.Longitude.Value,
			newRadius);
		}

		await FilterChanged.InvokeAsync(Filter);
	}

	private async Task ClearFilter()
	{
		Filter = new GroupSearchFilter();
		await FilterChanged.InvokeAsync(Filter);

		// Clear the map location if using map search
		if (_mapSearchEnabled && _mapSearchFilter is not null)
		{
			await _mapSearchFilter.ClearLocationAsync();
		}

		_recentlyClearedForm = true;
	}

	private void LocationChanged(string location)
	{
		Filter.Location = location;
		Filter.WithinRadiusKilometers ??= 10;
	}
}