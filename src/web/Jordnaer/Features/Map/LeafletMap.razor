@implements IAsyncDisposable
@inject ILeafletMapInterop LeafletMapInterop
@inject ILogger<LeafletMap> Logger

<div id="@MapId" style="@MapStyle"></div>

@code {
	private DotNetObjectReference<LeafletMap>? _dotNetHelper;
	private bool _isInitialized;

	[Parameter]
	public string MapId { get; set; } = $"map-{Guid.NewGuid()}";

	[Parameter]
	public double InitialLatitude { get; set; } = 56.0; // Center of Denmark

	[Parameter]
	public double InitialLongitude { get; set; } = 10.0; // Center of Denmark

	[Parameter]
	public int InitialZoom { get; set; } = 7;

	[Parameter]
	public string MapStyle { get; set; } = "height: 400px; width: 100%; border-radius: 8px;";

	[Parameter]
	public EventCallback<(double Latitude, double Longitude)> OnLocationSelected { get; set; }

	/// <summary>
	/// Callback invoked when the map has been initialized and is ready for use
	/// </summary>
	[Parameter]
	public EventCallback OnMapInitialized { get; set; }

	/// <summary>
	/// Public property to check if map is initialized
	/// </summary>
	public bool IsInitialized => _isInitialized;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			_dotNetHelper = DotNetObjectReference.Create(this);

			// Initialize the map
			var success = await LeafletMapInterop.InitializeMapAsync(
			MapId,
			InitialLatitude,
			InitialLongitude,
			InitialZoom);

			if (success)
			{
				// Setup click handler
				await LeafletMapInterop.SetupClickHandlerAsync(MapId, _dotNetHelper!);
				_isInitialized = true;
				await OnMapInitialized.InvokeAsync();
			}
		}
	}

	/// <summary>
	/// Called from JavaScript when the map is clicked
	/// </summary>
	[JSInvokable]
	public async Task OnMapClicked(double lat, double lng)
	{
		await OnLocationSelected.InvokeAsync((lat, lng));
	}

	/// <summary>
	/// Updates the search radius visualization on the map
	/// </summary>
	public async Task UpdateSearchRadiusAsync(double lat, double lng, int radiusKm, bool fitBounds = false)
	{
		if (!_isInitialized) return;

		await LeafletMapInterop.UpdateSearchRadiusAsync(MapId, lat, lng, radiusKm, fitBounds);
	}

	/// <summary>
	/// Centers the map on a specific location
	/// </summary>
	public async Task CenterMapAsync(double lat, double lng, int? zoom = null)
	{
		if (!_isInitialized) return;

		await LeafletMapInterop.CenterMapAsync(MapId, lat, lng, zoom);
	}

	/// <summary>
	/// Updates the marker position
	/// </summary>
	public async Task UpdateMarkerAsync(double lat, double lng)
	{
		if (!_isInitialized) return;

		await LeafletMapInterop.UpdateMarkerAsync(MapId, lat, lng);
	}

	/// <summary>
	/// Removes the marker from the map
	/// </summary>
	public async Task RemoveMarkerAsync()
	{
		if (!_isInitialized)
		{
			return;
		}

		await LeafletMapInterop.RemoveMarkerAsync(MapId);
	}

	/// <summary>
	/// Removes the search radius circle from the map
	/// </summary>
	public async Task RemoveSearchRadiusAsync()
	{
		if (!_isInitialized)
		{
			return;
		}

		await LeafletMapInterop.RemoveSearchRadiusAsync(MapId);
	}

	/// <summary>
	/// Updates group markers on the map with clustering
	/// </summary>
	public async Task<bool> UpdateGroupMarkersAsync(IEnumerable<GroupMarkerData> groups)
	{
		if (!_isInitialized)
		{
			return false;
		}

		var success = await LeafletMapInterop.UpdateGroupMarkersAsync(MapId, groups);
		if (!success)
		{
			Logger.LogWarning("Failed to update group markers on map {MapId}", MapId);
		}
		return success;
	}

	/// <summary>
	/// Clears all group markers from the map
	/// </summary>
	public async Task<bool> ClearGroupMarkersAsync()
	{
		if (!_isInitialized)
		{
			return false;
		}

		var success = await LeafletMapInterop.ClearGroupMarkersAsync(MapId);
		if (!success)
		{
			Logger.LogWarning("Failed to clear group markers on map {MapId}", MapId);
		}
		return success;
	}

	/// <summary>
	/// Fits the map view to show all group markers
	/// </summary>
	public async Task<bool> FitBoundsToMarkersAsync(int padding = 50)
	{
		if (!_isInitialized)
		{
			return false;
		}

		var success = await LeafletMapInterop.FitBoundsToMarkersAsync(MapId, padding);
		if (!success)
		{
			Logger.LogWarning("Failed to fit bounds to markers on map {MapId}", MapId);
		}
		return success;
	}

	/// <summary>
	/// Gets the current map view state (center and zoom)
	/// </summary>
	public async Task<MapViewState?> GetMapStateAsync()
	{
		if (!_isInitialized)
		{
			return null;
		}

		return await LeafletMapInterop.GetMapStateAsync(MapId);
	}

	public async ValueTask DisposeAsync()
	{
		if (_isInitialized)
		{
			await LeafletMapInterop.DisposeMapAsync(MapId);
		}

		_dotNetHelper?.Dispose();
	}
}