@using Jordnaer.Shared
@using Jordnaer.Features.Theme
@inject PostService PostService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject ICategoryCache CategoryCache

<MudCard Class="mb-4 warm-shadow warm-rounded" Elevation="3" Style="cursor: pointer;" @onclick="NavigateToPost">
    @* Header Section - Author Info *@
    <MudCardHeader Style="@($"border-bottom: 1px solid {JordnaerPalette.BeigeBackground}; padding-bottom: 12px;")">
        <CardHeaderAvatar>
            <MudAvatar Color="Color.Secondary">
                @if (string.IsNullOrEmpty(PostItem.Author.ProfilePictureUrl))
                {
                    @GetAvatarInitial()
                }
                else
                {
                    <MudImage Src="@PostItem.Author.ProfilePictureUrl" />
                }
            </MudAvatar>
        </CardHeaderAvatar>
        <CardHeaderContent>
            <MudText Typo="Typo.body1" Style="@($"font-weight: 600; color: {JordnaerPalette.BlueBody};")">
                <MudLink Underline="Underline.Hover"
                         title="@_title"
                         Href="@($"/{PostItem.Author.UserName}")"
                         Color="Color.Inherit">
                    @PostItem.Author.DisplayName
                </MudLink>
            </MudText>
            <MudText Typo="Typo.body2" Style="@($"color: {JordnaerPalette.BlueBody}; opacity: 0.7;")">
                @PostItem.CreatedUtc.ToLocalTime().ToString("g")
            </MudText>
            @if (PostItem.ZipCode is not null && !string.IsNullOrEmpty(PostItem.City))
            {
                <MudText Typo="Typo.caption" Style="@($"color: {JordnaerPalette.BlueBody}; opacity: 0.6;")">
                    üìç @PostItem.ZipCode, @PostItem.City.Sanitize()
                </MudText>
            }
        </CardHeaderContent>
        <CardHeaderActions>
            @if (PostItem.Author.Id == CurrentUserId)
            {
                <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                         AnchorOrigin="Origin.BottomRight"
                         Dense="true"
                         @onclick:stopPropagation="true">
                    <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                                 OnClick="OpenEditDialog">
                        Redig√©r
                    </MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Delete"
                                 OnClick="DeletePostAsync"
                                 IconColor="Color.Error">
                        Slet
                    </MudMenuItem>
                </MudMenu>
            }
        </CardHeaderActions>
    </MudCardHeader>

    @* Content Section *@
    <MudCardContent Style="padding: 16px; min-height: 60px;">
        <MudText Typo="Typo.body1"
                 Style="@($"color: {JordnaerPalette.BlueBody}; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;")">
            @PostItem.Text.SanitizeHtml()
        </MudText>
    </MudCardContent>

    @* Categories Section *@
    @if (PostItem.Categories.Any())
    {
        <MudDivider Style="@($"background-color: {JordnaerPalette.BeigeBackground}; opacity: 0.5;")" />
        <MudCardActions Style="padding: 12px 16px;">
            <MudStack Row Spacing="1" Wrap="Wrap.Wrap">
                @foreach (var (category, index) in PostItem.Categories.Select((c, i) => (c, i)))
                {
                    <MudChip T="string"
                             Size="Size.Small"
                             Class="warm-rounded"
                             Style="@GetCategoryChipStyle(index)">
                        @category
                    </MudChip>
                }
            </MudStack>
        </MudCardActions>
    }
</MudCard>

@code {
    private string _title => $"G√• til {PostItem.Author.UserName.Sanitize()}'s profil";

    [Parameter, EditorRequired]
    public required PostDto PostItem { get; set; }

    [Parameter, EditorRequired]
    public required string CurrentUserId { get; set; }

    [Parameter]
    public EventCallback<Guid> OnPostDeleted { get; set; }

    [Parameter]
    public EventCallback OnPostUpdated { get; set; }

    private void NavigateToPost()
    {
        Navigation.NavigateTo($"/posts/{PostItem.Id}");
    }

    private string GetAvatarInitial()
    {
        // Try DisplayName first
        if (!string.IsNullOrEmpty(PostItem.Author.DisplayName))
        {
            return PostItem.Author.DisplayName[0].ToString();
        }

        // Fallback to UserName
        if (!string.IsNullOrEmpty(PostItem.Author.UserName))
        {
            return PostItem.Author.UserName[0].ToString();
        }

        // Final fallback
        return "?";
    }

    private string GetCategoryChipStyle(int index)
    {
        // Rotate through brand colors
        var colors = new[]
        {
            (bg: JordnaerPalette.YellowBackground, fg: JordnaerPalette.White),
            (bg: JordnaerPalette.GreenBackground, fg: JordnaerPalette.White),
            (bg: JordnaerPalette.BeigeBackground, fg: JordnaerPalette.BlueBody)
        };

        var color = colors[index % colors.Length];
        return $"background-color: {color.bg}; color: {color.fg}; font-weight: 500; border: none;";
    }

    private async Task OpenEditDialog()
    {
        var categories = await CategoryCache.GetOrCreateCategoriesAsync();

        var parameters = new DialogParameters
        {
            { "PostId", PostItem.Id },
            { "InitialText", PostItem.Text },
            { "InitialCategories", PostItem.Categories.ToList() },
            { "AllCategories", categories.ToList() },
            { "CurrentUserId", CurrentUserId }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<EditPostDialog>("Redig√©r opslag", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await OnPostUpdated.InvokeAsync();
        }
    }

    private async Task DeletePostAsync()
    {
        var result = await DialogService.ShowMessageBox(
            "Slet opslag?",
            "Er du sikker p√• at du vil slette dette opslag?",
            yesText: "Slet",
            cancelText: "Annuller");

        if (result != true)
        {
            return;
        }

        var deletionResult = await PostService.DeletePostAsync(PostItem.Id, CurrentUserId);
        if (deletionResult.IsT0)
        {
            Snackbar.Add("Opslaget er slettet", Severity.Success);
            await OnPostDeleted.InvokeAsync(PostItem.Id);
        }
        else
        {
            Snackbar.Add(deletionResult.AsT1.Value, Severity.Error);
        }
    }

}