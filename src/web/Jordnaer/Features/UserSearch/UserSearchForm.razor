@using Jordnaer.Features.Map
@using Microsoft.FeatureManagement
@using MudBlazor
@using Variant = MudBlazor.Variant
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime
@inject IFeatureManager FeatureManager

<MudContainer MaxWidth="MaxWidth.Small">
    <MudPaper Elevation="3" Class="pa-10 mt-5">
        <p class="font-open-sans-light" style="color: @JordnaerPalette.RedHeader; font-size: 20px;">
            Find ligesindede nær dig
        </p>

        <MudDivider Class="mb-5 mt-1" />

        <EditForm OnValidSubmit="@OnValidSubmit" Model="Filter">
            <DataAnnotationsValidator />

            <MudGrid Justify="Justify.SpaceAround" Spacing="6">

                @if (_mapSearchEnabled)
                {
                    @* New map-based search experience *@
                    <MudItem xs="12">
                        <MapSearchFilter @ref="_mapSearchFilter" RadiusKm="@(Filter.WithinRadiusKilometers ?? 10)"
                            RadiusKmChanged="OnRadiusChanged" OnLocationSearchChanged="OnLocationSearchChanged" />
                    </MudItem>
                }
                else
                {
                    @* Existing zip code search *@
                    <MudItem xs="8">
                        <ZipCodeAutoComplete For="() => Filter.Location" Location="@Filter.Location"
                            LocationChanged="LocationChanged" DisableSmartCompletion="_disableSmartCompletionForZipCode" />
                    </MudItem>
                    <MudItem xs="4">
                        <MudNumericField For="() => Filter.WithinRadiusKilometers"
                            @bind-Value="Filter.WithinRadiusKilometers" Label="km" Placeholder="Radius">
                        </MudNumericField>
                    </MudItem>
                }

                <MudItem xs="12">
                    <CategorySelector @bind-Categories="Filter.Categories" />
                </MudItem>

                <MudItem xs="12" Class="mt-4">
                    <MudButton OnClick="ToggleAdvancedSearch" FullWidth Variant="Variant.Text" Color="Color.Info"
                        StartIcon="@(ExpandAdvancedSearch? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                        Style="text-transform: none; font-weight: normal;">
                        @(ExpandAdvancedSearch ? "Luk udvidet søgning" : "Udvidet søgning")
                    </MudButton>
                </MudItem>

                <MudItem xs="12">
                    <MudCollapse @bind-Expanded="ExpandAdvancedSearch">
                        <MudPaper Elevation="0" Class="pa-4 mt-2"
                            Style="@($"background-color: {JordnaerPalette.PaleBlueBackground}40; border-radius: 8px;")">

                            @* Name search *@
                            <MudTextField @bind-Value="Filter.Name" Label="Søg på navn"
                                Placeholder="Fornavn, efternavn eller brugernavn" Variant="Variant.Outlined"
                                Margin="Margin.Dense" Clearable Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.Person" />

                            @* Children filters section *@
                            <MudText Typo="Typo.subtitle1" Class="mt-5 mb-3"
                                Style="@($"color: {JordnaerPalette.RedHeader}; font-weight: 500;")">
                                <MudIcon Icon="@Icons.Material.Filled.ChildCare" Size="Size.Small" Class="mr-1" />
                                Børn
                            </MudText>

                            <MudGrid Spacing="2">
                                <MudItem xs="6">
                                    <MudNumericField For="() => Filter.MinimumChildAge"
                                        @bind-Value="Filter.MinimumChildAge" Label="Min. alder"
                                        Variant="Variant.Outlined" Margin="Margin.Dense" Min="0" Max="18" />
                                </MudItem>
                                <MudItem xs="6">
                                    <MudNumericField For="() => Filter.MaximumChildAge"
                                        @bind-Value="Filter.MaximumChildAge" Label="Max. alder"
                                        Variant="Variant.Outlined" Margin="Margin.Dense" Min="0" Max="18" />
                                </MudItem>
                            </MudGrid>

                            <MudSelect @bind-Value="Filter.ChildGender" Label="Køn" Variant="Variant.Outlined"
                                Margin="Margin.Dense" Clearable Placeholder="Vælg køn"
                                AnchorOrigin="Origin.BottomCenter" Class="mt-2">
                                @foreach (var gender in Enum.GetValues<Gender>())
                                {
                                    <MudSelectItem T="Gender?" Value="gender">@gender.GetDisplayName()</MudSelectItem>
                                }
                            </MudSelect>

                        </MudPaper>
                    </MudCollapse>

                </MudItem>

                <MudItem xs="12" sm="11" md="10" lg="9" xl="8">

                    <MudButtonGroup OverrideStyles="false" Style="width: 100%;">
                        <MudButton FullWidth Variant="Variant.Filled" Color="Color.Success"
                            ButtonType="ButtonType.Submit">
                            <MudIcon Icon="@Icons.Material.Filled.Search" />
                        </MudButton>
                        <MudButton OnClick="ClearFilter" Color="Color.Transparent" Variant="Variant.Filled"
                            ButtonType="ButtonType.Reset">
                            <MudIcon Icon="@Icons.Material.Filled.Clear" />
                        </MudButton>
                    </MudButtonGroup>

                </MudItem>
            </MudGrid>
        </EditForm>
    </MudPaper>
</MudContainer>

@code
{
    private MapSearchFilter? _mapSearchFilter;
    private bool _mapSearchEnabled = false;

    [Parameter]
    public required UserSearchFilter Filter { get; set; }

    [Parameter]
    public EventCallback<UserSearchFilter> FilterChanged { get; set; }

    [Parameter]
    public required EventCallback OnValidSubmit { get; set; }

    private bool ExpandAdvancedSearch { get; set; } = false;

    private static readonly UserSearchFilter DefaultFilter = new();

    private bool _recentlyClearedForm = false;
    private bool _disableSmartCompletionForZipCode => _recentlyClearedForm || Filter != DefaultFilter;

    protected override async Task OnInitializedAsync()
    {
        _mapSearchEnabled = await FeatureManager.IsEnabledAsync(FeatureFlags.MapSearch);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _mapSearchEnabled && _mapSearchFilter is not null)
        {
            // If we have lat/long in the filter from query string, set the map location
            if (Filter.Latitude.HasValue && Filter.Longitude.HasValue && Filter.WithinRadiusKilometers.HasValue)
            {
                await _mapSearchFilter.SetLocationAsync(
                Filter.Latitude.Value,
                Filter.Longitude.Value,
                13);
            }
        }
    }

    private async Task OnLocationSearchChanged((double Latitude, double Longitude, int RadiusKm, string? Address)
    locationSearch)
    {
        Filter.Latitude = locationSearch.Latitude;
        Filter.Longitude = locationSearch.Longitude;
        Filter.WithinRadiusKilometers = locationSearch.RadiusKm;
        Filter.Location = locationSearch.Address;

        await FilterChanged.InvokeAsync(Filter);
    }

    private async Task OnRadiusChanged(int newRadius)
    {
        Filter.WithinRadiusKilometers = newRadius;

        // Update the map if we have a location
        if (_mapSearchFilter is not null && Filter.Latitude.HasValue && Filter.Longitude.HasValue)
        {
            await _mapSearchFilter.UpdateSearchRadiusAsync(
            Filter.Latitude.Value,
            Filter.Longitude.Value,
            newRadius);
        }

        await FilterChanged.InvokeAsync(Filter);
    }

    private async Task ClearFilter()
    {
        Filter = new UserSearchFilter();
        await FilterChanged.InvokeAsync(Filter);

        // Clear the map location if using map search
        if (_mapSearchEnabled && _mapSearchFilter is not null)
        {
            await _mapSearchFilter.ClearLocationAsync();
        }

        _recentlyClearedForm = true;
        ExpandAdvancedSearch = false;
    }

    private void LocationChanged(string location)
    {
        Filter.Location = location;
        Filter.WithinRadiusKilometers ??= 10;
    }

    private void ToggleAdvancedSearch()
    {
        ExpandAdvancedSearch = !ExpandAdvancedSearch;
    }
}