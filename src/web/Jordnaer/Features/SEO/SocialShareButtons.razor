@using System.Text
@inject IJSRuntime JsRuntime
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration

<div class="d-flex gap-2 flex-wrap @Class">
    <MudTooltip Text="Del på Facebook">
        <MudIconButton Icon="@Icons.Custom.Brands.Facebook" Color="Color.Info" Size="@Size" OnClick="ShareToFacebook"
            aria-label="Del på Facebook" />
    </MudTooltip>

    <MudTooltip Text="@(_canUseNativeShare ? "Del på Instagram" : "Kopiér link til Instagram")">
        <MudIconButton Icon="@Icons.Custom.Brands.Instagram" Color="Color.Secondary" Size="@Size"
            OnClick="ShareToInstagramAsync" aria-label="Del på Instagram" />
    </MudTooltip>

    <MudTooltip Text="Kopiér link">
        <MudIconButton Icon="@Icons.Material.Filled.Link" Color="Color.Default" Size="@Size" OnClick="CopyLinkAsync"
            aria-label="Kopiér link" />
    </MudTooltip>
</div>

@code {
    [Parameter]
    public string? Title { get; set; }

    [Parameter]
    public string? Description { get; set; }

    [Parameter]
    public string? ShareUrl { get; set; }

    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public Size Size { get; set; } = Size.Medium;

    /// <summary>
    /// Default share text shown when sharing. Use this to encourage users to complete the share.
    /// </summary>
    [Parameter]
    public string? ShareText { get; set; }

    /// <summary>
    /// Optional hashtag to add to Facebook shares. Should include the # symbol (e.g., "#MiniMøder").
    /// </summary>
    [Parameter]
    public string? Hashtag { get; set; }

    private bool _canUseNativeShare;
    private string? _facebookAppId;
    private Uri _baseUri => NavigationManager.BaseUri.Contains("localhost") 
    ? new Uri("https://mini-moeder.dk")
    : new Uri(NavigationManager.BaseUri);
    private string FullShareUrl => string.IsNullOrEmpty(ShareUrl)
    ? NavigationManager.Uri
    : new Uri(new Uri(NavigationManager.BaseUri), ShareUrl).ToString();

    private string EffectiveShareText => !string.IsNullOrEmpty(ShareText)
    ? ShareText
    : !string.IsNullOrEmpty(Description)
    ? Description
    : Title ?? "Se dette på Mini Møder";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _canUseNativeShare = await JsRuntime.InvokeAsync<bool>("utilities.canShare");
            _facebookAppId = Configuration["Authentication:Schemes:Facebook:AppId"];
            StateHasChanged();
        }
    }

    private async Task ShareToFacebook()
    {
        // Use Facebook Share Dialog if App ID is provided, otherwise fall back to legacy sharer
        string facebookUrl;
        if (!string.IsNullOrEmpty(_facebookAppId))
        {
            // Facebook Share Dialog - better preview and hashtag support
            var shareUrlBuilder = new StringBuilder();
            shareUrlBuilder.Append("https://www.facebook.com/dialog/share");
            shareUrlBuilder.Append($"?app_id={_facebookAppId}");
            shareUrlBuilder.Append("&display=popup");
            shareUrlBuilder.Append($"&href={Uri.EscapeDataString(FullShareUrl)}");
            // redirect_uri is required - redirect back to the shared page after sharing
            shareUrlBuilder.Append($"&redirect_uri={Uri.EscapeDataString(FullShareUrl)}");

            if (!string.IsNullOrEmpty(Hashtag))
            {
                shareUrlBuilder.Append($"&hashtag={Uri.EscapeDataString(Hashtag)}");
            }

            facebookUrl = shareUrlBuilder.ToString();
        }
        else
        {
            // Legacy sharer - fallback if no App ID
            var encodedUrl = Uri.EscapeDataString(FullShareUrl);
            facebookUrl = $"https://www.facebook.com/sharer/sharer.php?u={encodedUrl}";
        }

        await JsRuntime.InvokeVoidAsync("utilities.openShareWindow", facebookUrl, "facebook-share");
    }

    private async Task ShareToInstagramAsync()
    {
        if (_canUseNativeShare)
        {
            // On mobile: Use native share sheet which includes Instagram
            var shared = await JsRuntime.InvokeAsync<bool>(
            "utilities.nativeShare",
            Title ?? "Mini Møder",
            EffectiveShareText,
            FullShareUrl);

            if (!shared)
            {
                // User cancelled or error - fall back to copy
                await CopyForInstagramAsync();
            }
        }
        else
        {
            // On desktop: Copy link with Instagram-specific message
            await CopyForInstagramAsync();
        }
    }

    private async Task CopyForInstagramAsync()
    {
        var success = await JsRuntime.InvokeAsync<bool>("utilities.copyToClipboard", FullShareUrl);
        if (success)
        {
            Snackbar.Add("Link kopieret! Du kan nu indsætte det på Instagram.", Severity.Success);
        }
        else
        {
            Snackbar.Add("Kunne ikke kopiere linket. Prøv igen.", Severity.Error);
        }
    }

    private async Task CopyLinkAsync()
    {
        var success = await JsRuntime.InvokeAsync<bool>("utilities.copyToClipboard", FullShareUrl);
        if (success)
        {
            Snackbar.Add("Link kopieret til udklipsholder!", Severity.Success);
        }
        else
        {
            Snackbar.Add("Kunne ikke kopiere linket. Prøv igen.", Severity.Error);
        }
    }
}