@using Jordnaer.Features.UserSearch
@using Jordnaer.Shared
@using MudBlazor
@using OneOf.Types
@using System.ComponentModel.DataAnnotations

@inherits CancellableComponent

@inject IMembershipService MembershipService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-4">Inviter medlem til gruppen</MudText>

        <MudTabs @bind-ActivePanelIndex="_activeTab" Elevation="0" Rounded ApplyEffectsToContainer Class="mb-4">
            <MudTabPanel Text="Søg efter bruger" Icon="@Icons.Material.Filled.PersonSearch">
                <MudStack Class="pt-4">
                    <UserSearchAutocomplete CurrentUserId="@CurrentUserId"
                                            UserSelected="@UserSelected"
                                            Disabled="@_isInviting"
                                            ShowUsername="true"
                                            AvatarSize="Size.Medium" />

                    @if (_selectedUser is not null)
                    {
                        <MudPaper Class="mt-4 pa-4" Elevation="0" Outlined>
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="3">
                                <MudAvatar Size="Size.Large">
                                    <MudImage Src="@_selectedUser.ProfilePictureUrl" loading="lazy" Alt="Avatar" />
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.subtitle1">@_selectedUser.DisplayName</MudText>
                                    @if (!string.IsNullOrEmpty(_selectedUser.UserName))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@@@_selectedUser.UserName</MudText>
                                    }
                                </div>
                                <MudSpacer />
                                <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="ClearSelection" />
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            </MudTabPanel>
            <MudTabPanel Text="Inviter via email" Icon="@Icons.Material.Filled.Email">
                <MudStack Class="pt-4">
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                        Send en invitation til en person der endnu ikke er registreret på Mini Møder.
                    </MudText>
                    <MudTextField @bind-Value="_inviteEmail"
                                  Label="Email-adresse"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Email"
                                  Disabled="@_isInviting"
                                  Validation="@(new EmailAddressAttribute { ErrorMessage = "Indtast venligst en gyldig email-adresse." })"
                                  Immediate
                                  HelperText="Personen modtager en email med invitation til at oprette en konto og deltage i gruppen." />
                </MudStack>
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Disabled="_isInviting">Annuller</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="InviteUser"
                   Disabled="@(IsInviteButtonDisabled)">
            @if (_isInviting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate />
                <MudText Class="ml-2">Inviterer...</MudText>
            }
            else
            {
                <text>Inviter</text>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private const int SearchUserTab = 0;
    private const int InviteByEmailTab = 1;

    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public required Guid GroupId { get; set; }
    [Parameter] public required string CurrentUserId { get; set; }

    private UserSlim? _selectedUser;
    private string _inviteEmail = string.Empty;
    private bool _isInviting;
    private int _activeTab;

    private bool IsInviteButtonDisabled
    {
        get
        {
            if (_isInviting) return true;

            if (_activeTab == SearchUserTab)
            {
                return _selectedUser is null;
            }

            // InviteByEmailTab
            var trimmedEmail = _inviteEmail?.Trim();
            return string.IsNullOrWhiteSpace(trimmedEmail) || !IsValidEmail(trimmedEmail);
        }
    }

    private static bool IsValidEmail(string email)
    {
        return new EmailAddressAttribute().IsValid(email);
    }

    private Task UserSelected(UserSlim? user)
    {
        _selectedUser = user;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void ClearSelection()
    {
        _selectedUser = null;
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task InviteUser()
    {
        _isInviting = true;

        if (_activeTab == SearchUserTab)
        {
            if (_selectedUser is null)
            {
                _isInviting = false;
                return;
            }

            var result = await MembershipService.InviteUserToGroupAsync(GroupId, _selectedUser.Id, CancellationToken);

            result.Switch(
                success =>
                {
                    Snackbar.Add($"{_selectedUser.DisplayName} er blevet inviteret til gruppen.", Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                },
                error =>
                {
                    Snackbar.Add(error.Value, Severity.Error);
                    _isInviting = false;
                    StateHasChanged();
                }
            );
        }
        else // InviteByEmailTab
        {
            var email = _inviteEmail?.Trim();
            if (string.IsNullOrWhiteSpace(email) || !IsValidEmail(email))
            {
                _isInviting = false;
                return;
            }

            var result = await MembershipService.InviteByEmailAsync(GroupId, email, CancellationToken);

            result.Switch(
                success =>
                {
                    Snackbar.Add($"Invitation sendt til {email}.", Severity.Success);
                    MudDialog.Close(DialogResult.Ok(true));
                },
                error =>
                {
                    Snackbar.Add(error.Value, Severity.Error);
                    _isInviting = false;
                    StateHasChanged();
                }
            );
        }
    }
}
