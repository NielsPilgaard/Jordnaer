@page "/Account/ConfirmEmail"

@using System.Text
@using Microsoft.AspNetCore.WebUtilities
@using Jordnaer.Features.Profile
@using Jordnaer.Features.Membership

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IProfileService ProfileService
@inject IMembershipService MembershipService
@inject IdentityRedirectManager RedirectManager
@inject ILogger<ConfirmEmail> Logger

<MetadataComponent Title="Bekræft email" />

<div class="account-container">
    <div class="account-paper">
        <h1 class="account-header">Bekræft email</h1>
        <StatusMessage Message="@_statusMessage" />
    </div>
</div>

@code {
    private AlertMessage? _statusMessage;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromQuery]
    private string? UserId { get; set; }

    [SupplyParameterFromQuery]
    private string? Code { get; set; }

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery]
    private string? InviteToken { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (UserId is null || Code is null)
        {
            RedirectManager.RedirectTo("");
        }

        var user = await UserManager.FindByIdAsync(UserId);
        if (user is null)
        {
            HttpContext.Response.StatusCode = StatusCodes.Status404NotFound;
            _statusMessage = new AlertMessage($"Fejl ved indlæsning af bruger med ID {UserId}", true);
        }
        else
        {
            var code = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(Code));
            var result = await UserManager.ConfirmEmailAsync(user, code);
            if (result.Succeeded)
            {
                _statusMessage = new AlertMessage("Tak fordi du bekræftede din email, du bliver nu logget ind.");

                await SignInManager.SignInAsync(user, isPersistent: true);

                // Check if profile is complete and redirect accordingly
                var profileCheckResult = await ProfileService.IsProfileCompleteAsync(user.Id);
                if (profileCheckResult.IsT1)
                {
                    Logger.LogError("Failed to check profile completeness for user {UserId}: {Error}",
                        user.Id, profileCheckResult.AsT1.Value);
                    _statusMessage = new AlertMessage("Der opstod en fejl ved kontrol af din profil. Prøv venligst igen.", true);
                    return;
                }

                var isProfileComplete = profileCheckResult.AsT0.Value;

                // Determine redirect based on invite token and profile completion
                string? groupRedirectUrl = null;

                // If there's an invite token and profile is complete, accept the invite now
                if (!string.IsNullOrWhiteSpace(InviteToken))
                {
                    // Validate the token to get the group info for redirect
                    var tokenResult = await MembershipService.ValidateInviteTokenAsync(InviteToken);
                    tokenResult.Switch(
                        invite =>
                        {
                            if (invite.Group is not null)
                            {
                                groupRedirectUrl = $"/groups/{Uri.EscapeDataString(invite.Group.Name)}";
                            }
                        },
                        notFound => { /* Token not found - ignore */ },
                        error => Logger.LogWarning("Invite token validation failed: {Error}", error.Value)
                    );

                    // If profile is complete, accept the invite now
                    if (isProfileComplete)
                    {
                        var acceptResult = await MembershipService.AcceptPendingInviteAsync(user.Id, InviteToken);
                        acceptResult.Switch(
                            success => Logger.LogInformation("User {UserId} accepted pending group invite", user.Id),
                            notFound => Logger.LogWarning("Pending invite not found for user {UserId}", user.Id),
                            error => Logger.LogWarning("Failed to accept pending invite for user {UserId}: {Error}", user.Id, error.Value)
                        );
                    }
                }

                if (!isProfileComplete)
                {
                    // Pass invite token through to profile completion flow
                    var queryParams = new Dictionary<string, object?>();
                    if (!string.IsNullOrWhiteSpace(ReturnUrl))
                    {
                        queryParams["returnUrl"] = ReturnUrl;
                    }
                    else if (!string.IsNullOrWhiteSpace(groupRedirectUrl))
                    {
                        queryParams["returnUrl"] = groupRedirectUrl;
                    }
                    if (!string.IsNullOrWhiteSpace(InviteToken))
                    {
                        queryParams["inviteToken"] = InviteToken;
                    }

                    RedirectManager.RedirectTo("/CompleteProfile", queryParameters: queryParams);
                }
                else
                {
                    // Profile is complete - redirect to group or return URL
                    var redirectUrl = !string.IsNullOrWhiteSpace(groupRedirectUrl)
                        ? groupRedirectUrl
                        : (string.IsNullOrEmpty(ReturnUrl) ? "/" : ReturnUrl);
                    RedirectManager.RedirectTo(redirectUrl);
                }
            }
            else
            {
                _statusMessage = new AlertMessage("Fejl ved bekræftelse af email.", true);
            }
        }
    }
}