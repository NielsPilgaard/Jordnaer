@page "/groups/create"
@using NetTopologySuite.Geometries

@attribute [Authorize]

@inject GroupService GroupService
@inject ICategoryCache CategoryCache
@inject ILocationService LocationService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MetadataComponent Title="Opret gruppe" Description="Her kan du oprette din gruppe." />

<MudLoading @bind-Loading="_isLoading" Darken Overlap>
    <MudContainer MaxWidth="MaxWidth.Large" Class="my-6">

        <MudText Typo="Typo.h3" Class="mb-5 font-cherry-bomb-one" Style="@($"color: {JordnaerPalette.RedHeader};")">
            Opret Gruppe
        </MudText>

        <EditForm Model="@_group" OnValidSubmit="Create">
            <DataAnnotationsValidator />
            <MudPaper Elevation="3" Class="pa-4">

                <GroupProfilePicture @bind-Group="_group" />

                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_group.Name" For="() => _group.Name" Label="Gruppenavn"
                            Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="8">
                        <MudTextField @bind-Value="_group.ShortDescription" For="() => _group.ShortDescription"
                            Label="Kort beskrivelse" Variant="Variant.Outlined" />
                    </MudItem>
                    @* Location Section *@
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Lokation</MudText>
                    </MudItem>

                    <MudItem xs="12" md="8" lg="6">
                        @if (_useZipCodeOnly)
                        {
                            <ZipCodeAutoComplete Location="@_zipCodeLocation" LocationChanged="OnZipCodeLocationChanged"
                                For="() => _zipCodeLocation" DisableSmartCompletion="true" />
                        }
                        else
                        {
                            <AddressAutoComplete Address="@_addressLocation" AddressChanged="OnAddressLocationChanged"
                                For="() => _addressLocation" />
                        }
                    </MudItem>

                    <MudItem xs="12" md="4" lg="6" Class="d-flex align-center text-center justify-content-center">
                        <MudTooltip Text="Klik for at skifte mellem fuld adresse og kun postnummer.">
                            <MudChip T="string" Size="Size.Large" Color="@(_useZipCodeOnly? Color.Default: Color.Info)"
                                Variant="Variant.Outlined" OnClick="@ToggleLocationMode" Style="cursor: pointer;">
                                @if (_useZipCodeOnly)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" Class="mr-1" />
                                    <span>Kun postnummer</span>
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                    <span>Fuld adresse</span>
                                }
                            </MudChip>
                        </MudTooltip>
                    </MudItem>

                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense Class="pa-3">
                            Gruppens lokation hjælper andre med at finde grupper i deres område.
                        </MudAlert>
                    </MudItem>
                    <MudItem xs="12">
                        <MudText Typo="Typo.body1" Class="mb-2">Kategorier</MudText>
                        <CategorySelector @bind-Categories="_selectedCategoryNames" />
                    </MudItem>
                    <MudItem xs="12">
                        <TextEditorComponent Placeholder="Beskriv din gruppe her..." Label="Beskrivelse" Text="@null"
                            @ref="_textEditorComponent" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
            <MudButton Size="Size.Large" StartIcon="@Icons.Material.Filled.Save" Class="my-6"
                ButtonType="ButtonType.Submit" Variant="Variant.Filled" FullWidth
                Style="@($"background-color: {JordnaerPalette.GreenBackground}; color: white;")">
                Opret Gruppe
            </MudButton>
        </EditForm>

    </MudContainer>
</MudLoading>

@code {
    private TextEditorComponent _textEditorComponent = default!;
    private Group _group = new()
    {
        Id = NewId.NextGuid(),
        Name = string.Empty,
        ShortDescription = string.Empty
    };

    private IEnumerable<Category> _categories = Enumerable.Empty<Category>();
    private bool _isLoading = true;

    private bool _useZipCodeOnly = true;
    private string _zipCodeLocation = string.Empty;
    private string _addressLocation = string.Empty;
    private string[]? _selectedCategoryNames = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        if (!RendererInfo.IsInteractive)
        {
            return;
        }

        _categories = await CategoryCache.GetOrCreateCategoriesAsync();
        _isLoading = false;
    }

    private async Task OnAddressLocationChanged(string address)
    {
        _addressLocation = address;

        if (string.IsNullOrWhiteSpace(address))
        {
            _group.ClearLocation();
            return;
        }

        var result = await LocationService.GetLocationFromAddressAsync(address);
        if (result is not null)
        {
            _group.ApplyAddressLocation(address, result);
        }
        else
        {
            Snackbar.Add("Kunne ikke hente lokationsdata. Prøv venligst igen om et par minutter.",
            Severity.Warning);
        }
    }

    private async Task OnZipCodeLocationChanged(string zipCode)
    {
        _zipCodeLocation = zipCode;

        if (string.IsNullOrWhiteSpace(zipCode))
        {
            _group.ClearLocation();
            return;
        }

        var result = await LocationService.GetLocationFromZipCodeAsync(zipCode);
        if (result is not null)
        {
            _group.ApplyZipCodeLocation(result);
        }
        else
        {
            Snackbar.Add("Kunne ikke hente lokationsdata. Prøv venligst igen om et par minutter.",
            Severity.Warning);
        }
    }

    private void ToggleLocationMode()
    {
        _useZipCodeOnly = !_useZipCodeOnly;

        _group.ClearLocation();
        _zipCodeLocation = string.Empty;
        _addressLocation = string.Empty;
    }

    private async Task Create()
    {
        _isLoading = true;

        // Sync selected categories to group
        _group.Categories = _categories
        .Where(c => _selectedCategoryNames != null && _selectedCategoryNames.Contains(c.Name))
        .ToList();

        _group.Description = await _textEditorComponent.GetHtmlAsync();

        var response = await GroupService.CreateGroupAsync(_group);
        response.Switch(
        _ =>
        {
            Snackbar.Add("Gruppen blev oprettet.", Severity.Success);
            Navigation.NavigateTo($"/groups/{Uri.EscapeDataString(_group.Name)}");
        },
        badRequest => Snackbar.Add(badRequest.Value, Severity.Warning));

        _isLoading = false;
    }
}