@page "/groups/my-groups"

@attribute [Authorize]

@inject GroupService GroupService

<MetadataComponent Title="Mine Grupper" Description="Oversigt over dine grupper, og dine afventende anmodninger" />

<MudContainer MaxWidth="MaxWidth.Large">

    <MudLoading @bind-Loading="_isLoading" Darken Overlap>

        @* Pending Requests Alert *@
        @if (_pendingAccess.Length > 0)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                Du har @_pendingAccess.Length afventende anmodning@(_pendingAccess.Length > 1 ? "er" : "").
            </MudAlert>
        }
        @* Header with back button *@
        <div class="d-flex align-center justify-space-between mb-4">
            <BackButton Href="/groups" />

            <MudButton Href="/groups/create" Variant="Variant.Filled"
                Style="@($"background-color: {JordnaerPalette.GreenBackground}; color: white;")"
                StartIcon="@Icons.Material.Filled.Add">
                Opret Gruppe
            </MudButton>
        </div>

        @* Tabs for Owned vs Member Groups *@
        <MudPaper Elevation="2" Class="mb-4">

            <MudTabs Elevation="0" Rounded ApplyEffectsToContainer PanelClass="pa-6"
                Style="@($"--mud-palette-primary: {JordnaerPalette.GreenBackground};")">

                @* Groups I Own *@
                <MudTabPanel Text="Grupper Jeg Ejer" Icon="@Icons.Material.Filled.Star">
                    @if (_ownedGroups.Length > 0)
                    {
                        <MudGrid Justify="Justify.FlexStart" Spacing="4">
                            @foreach (var group in _ownedGroups)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <GroupSummaryCard UserGroupAccess="group"></GroupSummaryCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            Du ejer ingen grupper endnu.
                        </MudAlert>
                    }
                </MudTabPanel>

                @* Groups I'm a Member Of *@
                <MudTabPanel Text="Medlem Af" Icon="@Icons.Material.Filled.Group">
                    @if (_memberGroups.Length > 0)
                    {
                        <MudGrid Justify="Justify.FlexStart" Spacing="4">
                            @foreach (var group in _memberGroups)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <GroupSummaryCard UserGroupAccess="group"></GroupSummaryCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            Du er ikke medlem af nogen grupper endnu.
                        </MudAlert>
                    }
                </MudTabPanel>

                @* Pending Requests *@
                <MudTabPanel Text="Afventende" Icon="@Icons.Material.Filled.Schedule"
                    BadgeData="@(_pendingAccess.Length > 0 ? _pendingAccess.Length.ToString() : null)"
                    BadgeColor="Color.Warning">
                    @if (_pendingAccess.Length > 0)
                    {
                        <MudGrid Justify="Justify.FlexStart" Spacing="4">
                            @foreach (var group in _pendingAccess)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <GroupSummaryCard UserGroupAccess="group"></GroupSummaryCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            Du har ingen afventende anmodninger.
                        </MudAlert>
                    }
                </MudTabPanel>

            </MudTabs>
        </MudPaper>

    </MudLoading>

</MudContainer>
@code {
    private bool _isLoading = true;

    private UserGroupAccess[] _ownedGroups = Array.Empty<UserGroupAccess>();
    private UserGroupAccess[] _memberGroups = Array.Empty<UserGroupAccess>();
    private UserGroupAccess[] _pendingAccess = Array.Empty<UserGroupAccess>();

    protected override async Task OnInitializedAsync()
    {
        if (!RendererInfo.IsInteractive)
        {
            return;
        }

        await LoadGroups();
        _isLoading = false;
    }

    private async Task LoadGroups()
    {
        var groupSummaries = await GroupService.GetSlimGroupsForUserAsync();

        // Separate owned groups from member groups
        _ownedGroups = groupSummaries
        .Where(x => x.MembershipStatus is MembershipStatus.Active &&
        (x.OwnershipLevel is OwnershipLevel.Owner or OwnershipLevel.InheritsOwnership))
        .OrderBy(x => x.Group.Name)
        .ToArray();

        _memberGroups = groupSummaries
        .Where(x => x.MembershipStatus is MembershipStatus.Active &&
        x.OwnershipLevel is OwnershipLevel.Member or OwnershipLevel.None)
        .OrderBy(x => x.Group.Name)
        .ToArray();

        _pendingAccess = groupSummaries
        .Where(x => x.MembershipStatus is MembershipStatus.PendingApprovalFromGroup or
        MembershipStatus.PendingApprovalFromUser)
        .OrderByDescending(x => x.LastUpdatedUtc)
        .ToArray();
    }
}