@page "/groups/{GroupId:guid}/edit"
@using NetTopologySuite.Geometries

@attribute [Authorize]

@inject GroupService GroupService
@inject ICategoryCache CategoryCache
@inject ILocationService LocationService
@inject ISnackbar Snackbar
@inject IJSRuntime JsRuntime

<MetadataComponent Title="Redigér gruppe" Image="@_group?.ProfilePictureUrl" />

<MudLoading @bind-Loading="_isLoading" Darken Overlap>

    <BackButton Class="mb-5" />

    @if (_group is null)
    {
        return;
    }


    <EditForm Model="@_group" OnValidSubmit="Update">
        <DataAnnotationsValidator />
        <MudPaper Elevation="3" Class="pa-4">

            <GroupProfilePicture @bind-Group="_group" />

            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudTextField @bind-Value="_group.Name" For="() => _group.Name" Label="Gruppenavn"
                        Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="8">
                    <MudTextField @bind-Value="_group.ShortDescription" For="() => _group.ShortDescription"
                        Label="Kort beskrivelse" Variant="Variant.Outlined" />
                </MudItem>
                @* Location Section *@
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">Lokation</MudText>
                </MudItem>

                <MudItem xs="12" md="8" lg="6">
                    @if (_useZipCodeOnly)
                    {
                        <ZipCodeAutoComplete Location="@_zipCodeLocation" LocationChanged="OnZipCodeLocationChanged"
                            For="() => _zipCodeLocation" DisableSmartCompletion="true" />
                    }
                    else
                    {
                        <AddressAutoComplete Address="@_addressLocation" AddressChanged="OnAddressLocationChanged"
                            For="() => _addressLocation" />
                    }
                </MudItem>

                <MudItem xs="12" md="4" lg="6" Class="d-flex align-center text-center justify-content-center">
                    <MudTooltip Text="Klik for at skifte mellem fuld adresse og kun postnummer.">
                        <MudChip T="string" Size="Size.Large" Color="@(_useZipCodeOnly? Color.Default: Color.Info)"
                            Variant="Variant.Outlined" OnClick="@ToggleLocationMode" Style="cursor: pointer;">
                            @if (_useZipCodeOnly)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" Class="mr-1" />
                                <span>Kun postnummer</span>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                <span>Fuld adresse</span>
                            }
                        </MudChip>
                    </MudTooltip>
                </MudItem>

                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense Class="pa-3">
                        Gruppens lokation hjælper andre med at finde grupper i deres område.
                    </MudAlert>
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.body1" Class="mb-2">Kategorier</MudText>
                    <CategorySelector @bind-Categories="_selectedCategoryNames" />
                </MudItem>
                <MudItem xs="12">
                    <TextEditorComponent Placeholder="Beskriv din gruppe her..." Label="Beskrivelse"
                        Text="@_group.Description" @ref="_textEditorComponent" />
                </MudItem>
            </MudGrid>
        </MudPaper>
        <MudButton Size="Size.Large" StartIcon="@Icons.Material.Filled.Save" Class="my-6" ButtonType="ButtonType.Submit"
            Variant="Variant.Filled" FullWidth Color="Color.Success">
            Opdatér
        </MudButton>
    </EditForm>
</MudLoading>

@code {
    [Parameter]
    public Guid GroupId { get; set; }

    private Group? _group;

    private IEnumerable<Category> _categories = Enumerable.Empty<Category>();
    private bool _isLoading = true;

    private bool _useZipCodeOnly = false;
    private string _zipCodeLocation = string.Empty;
    private string _addressLocation = string.Empty;
    private string[]? _selectedCategoryNames;

    private TextEditorComponent _textEditorComponent = default!;

    protected override async Task OnInitializedAsync()
    {
        var getGroupResponse = await GroupService.GetGroupByIdAsync(GroupId);
        getGroupResponse.Switch(
        group => _group = group,
        _ => Snackbar.Add("Det lykkedes ikke at finde gruppen.", Severity.Warning));

        _categories = await CategoryCache.GetOrCreateCategoriesAsync();

        // Initialize location fields from existing data
        if (_group is not null)
        {
            if (_group.Address is not null)
            {
                _addressLocation = _group.Address;
                _useZipCodeOnly = false;
            }
            else if (_group.ZipCode is not null && _group.City is not null)
            {
                _zipCodeLocation = $"{_group.ZipCode} {_group.City}";
                _useZipCodeOnly = true;
            }

            // Initialize selected category names
            _selectedCategoryNames = _group.Categories.Select(c => c.Name).ToArray();
        }

        _isLoading = false;
    }

    private async Task OnAddressLocationChanged(string address)
    {
        _addressLocation = address;

        if (_group is null)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(address))
        {
            _group.Address = null;
            _group.ZipCode = null;
            _group.City = null;
            _group.Location = null;
            _group.ZipCodeLocation = null;
            return;
        }

        var result = await LocationService.GetLocationFromAddressAsync(address);
        if (result is not null)
        {
            _group.Address = address;
            _group.ZipCode = result.ZipCode;
            _group.City = result.City;
            _group.Location = result.Location;
            _group.ZipCodeLocation = result.ZipCodeLocation;
        }
        else
        {
            Snackbar.Add("Kunne ikke hente lokationsdata. Prøv venligst igen om et par minutter.",
            Severity.Warning);
        }
    }

    private async Task OnZipCodeLocationChanged(string zipCode)
    {
        _zipCodeLocation = zipCode;

        if (_group is null)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(zipCode))
        {
            _group.Address = null;
            _group.ZipCode = null;
            _group.City = null;
            _group.Location = null;
            _group.ZipCodeLocation = null;
            return;
        }

        var result = await LocationService.GetLocationFromZipCodeAsync(zipCode);
        if (result is not null)
        {
            _group.Address = null; // Don't store address when using zip code only
            _group.ZipCode = result.ZipCode;
            _group.City = result.City;
            _group.Location = result.Location;
            // When using zip code only, both locations are the same (zip code center)
            _group.ZipCodeLocation = result.Location;
        }
        else
        {
            Snackbar.Add("Kunne ikke hente lokationsdata. Prøv venligst igen om et par minutter.",
            Severity.Warning);
        }
    }

    private void ToggleLocationMode()
    {
        _useZipCodeOnly = !_useZipCodeOnly;

        if (_group is not null)
        {
            _group.Address = null;
            _group.ZipCode = null;
            _group.City = null;
            _group.Location = null;
        }

        _zipCodeLocation = string.Empty;
        _addressLocation = string.Empty;
    }

    private async Task Update()
    {
        _isLoading = true;

        if (_group is null)
        {
            Snackbar.Add(ErrorMessages.Something_Went_Wrong_Try_Again, Severity.Error);
            _isLoading = false;
            return;
        }

        // Sync selected categories back to group
        _group.Categories = _categories
        .Where(c => _selectedCategoryNames != null && _selectedCategoryNames.Contains(c.Name))
        .ToList();

        _group.Description = await _textEditorComponent.GetHtmlAsync();

        var updateResult = await GroupService.UpdateGroupAsync(_group);

        updateResult.Switch(
        success => Snackbar.Add("Gruppen blev opdateret.", Severity.Success),
        error => Snackbar.Add(error.Value, Severity.Error));

        _isLoading = false;
    }
}