@page "/groups/{GroupName}"

@using Jordnaer.Features.GroupPosts
@using Jordnaer.Features.Map

@attribute [Sitemap]

@inherits CancellableComponent

@inject GroupService GroupService
@inject IMembershipService MembershipService
@inject IJSRuntime JsRuntime
@inject IProfileCache ProfileCache
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudLoading @bind-Loading="_isLoading" Darken Overlap>

    @if (_group is null && _isLoading is false)
    {
        <NotFoundComponent Message="@_groupNotFoundMessage" />
        return;
    }

    <MetadataComponent Title="@_group?.Name"
        Description="@($"Beskrivelse af {_group?.Name}:\n {_group?.ShortDescription}")"
        ImageUrl="@_group?.ProfilePictureUrl" />

    <!-- Top Action Bar -->
    <div class="d-flex align-center mb-6 gap-2">
        <BackButton Class="mr-2" />

        @if (_group is not null)
        {
            <SocialShareButtons Title="@_group.Name" Description="@_group.ShortDescription"
                ShareUrl="@($"/groups/{GroupName}")" Size="Size.Small" />
        }

        <MudSpacer />

        <AuthorizeView>
            <Authorized>
                <div class="d-flex gap-2 flex-wrap justify-end">
                    @if (_isMember is false)
                    {
                        <OpenChat Disabled="_isMember" Recipients="_recipients"
                            ChatName="@($"{GroupName} & {_currentUser?.DisplayName}")" />

                        <MudButton Disabled="_hasPendingMembershipRequest || _isMember" Variant="Variant.Filled"
                            Color="Color.Tertiary" OnClick="RequestMembership" StartIcon="@Icons.Material.Filled.GroupAdd">
                            Anmod om Medlemskab
                        </MudButton>
                    }

                    @if (_isMember && !_currentUserIsOwner)
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Error"
                            OnClick="LeaveGroup" StartIcon="@Icons.Material.Filled.ExitToApp">
                            Forlad Gruppe
                        </MudButton>
                    }

                    @if (_currentUserIsAdmin && _group is not null)
                    {
                        <MudButton OnClick="OpenInviteDialog"
                                   Variant="Variant.Filled"
                                   Color="Color.Success"
                                   StartIcon="@Icons.Material.Filled.PersonAdd">
                            Invitér Medlem
                        </MudButton>

                        <MudButton Href="@($"/groups/{_group?.Id}/edit")" Variant="Variant.Outlined" Color="Color.Info"
                            StartIcon="@Icons.Material.Filled.Edit">
                            Redigér
                        </MudButton>
                    }
                </div>
            </Authorized>
        </AuthorizeView>
    </div>

    @* Pending Requests Alert for Admins/Owners *@
    @if (_currentUserIsAdmin && _pendingRequestCount > 0)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Class="mb-4" NoIcon>
            <div class="d-flex align-center justify-space-between flex-wrap gap-2">
                <MudText Typo="Typo.body1">
                    <b>@_pendingRequestCount</b> afventende medlemskabsanmodning@(_pendingRequestCount > 1 ? "er" : "")
                </MudText>
                <MudButton Href="@($"/groups/{GroupName}/members")"
                          Variant="Variant.Filled"
                          Color="Color.Warning"
                          StartIcon="@Icons.Material.Filled.PersonAdd"
                          Size="Size.Small">
                    Administrér medlemmer
                </MudButton>
            </div>
        </MudAlert>
    }

    @* Pending Invite Alert for User *@
    @if (_hasPendingInvite && _group is not null)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-4" Elevation="4" NoIcon>
            <div class="d-flex align-center justify-space-between flex-wrap gap-2">
                <MudText Typo="Typo.body1" Class="font-weight-bold">
                    Du er blevet inviteret til at blive medlem af denne gruppe
                </MudText>
                <div class="d-flex gap-2">
                    <MudButton OnClick="AcceptInvite"
                              Variant="Variant.Filled"
                              Color="Color.Secondary"
                              StartIcon="@Icons.Material.Filled.Check"
                              Size="Size.Small"
                              Disabled="_processingInvite">
                        @if (_processingInvite && _isAcceptingInvite)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate />
                        }
                        else
                        {
                            <text>Acceptér</text>
                        }
                    </MudButton>
                    <MudButton OnClick="DeclineInvite"
                              Variant="Variant.Filled"
                              Color="Color.Default"
                              StartIcon="@Icons.Material.Filled.Close"
                              Size="Size.Small"
                              Disabled="_processingInvite">
                        @if (_processingInvite && !_isAcceptingInvite)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate />
                        }
                        else
                        {
                            <text>Afvis</text>
                        }
                    </MudButton>
                </div>
            </div>
        </MudAlert>
    }

    <MudGrid>
        <!-- Left Sidebar: Info & Members -->
        <MudItem xs="12" md="4">
            <MudStack Spacing="4">
                @if (_group is null)
                {
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="300px" />
                }
                else
                {
                    <GroupCard Group="_group" />
                }

                @* Location Info *@
                <MudPaper Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-2">Lokation</MudText>
                    @if (_group is null || (_group.ZipCode is null && string.IsNullOrEmpty(_group.City)))
                    {
                        @* State 1: No location info *@
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.LocationOff" Size="Size.Small" Class="mr-2"
                                Color="Color.Default" />
                            <MudText Typo="Typo.body1" Color="Color.Default">Ikke angivet</MudText>
                        </div>
                    }
                    else if (string.IsNullOrEmpty(_group.Address))
                    {
                        @* State 2: Zip code only - show map at zip code center for everyone *@
                        <div class="d-flex align-center mb-3">
                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-2"
                                Style="@($"color: {JordnaerPalette.BlueBody};")" />
                            <MudText Typo="Typo.body1">
                                @FormatLocation(_group.City, _group.ZipCode)
                            </MudText>
                        </div>
                        @if (_group.Latitude.HasValue && _group.Longitude.HasValue)
                        {
                            <LeafletMap InitialLatitude="_group.Latitude.Value" InitialLongitude="_group.Longitude.Value"
                                InitialZoom="12" MapStyle="height: 200px; width: 100%; border-radius: 8px;"
                                OnMapInitialized="OnMapInitializedAsync" @ref="_leafletMap" />
                        }
                    }
                    else
                    {
                        @* State 3: Full address - members see exact location, non-members see zip code area *@
                        @if (_isMember)
                        {
                            @* Member view: Show full address and exact location *@
                            <div class="d-flex align-center mb-3">
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-2"
                                    Style="@($"color: {JordnaerPalette.BlueBody};")" />
                                <MudText Typo="Typo.body1">@_group.Address</MudText>
                            </div>
                            @if (_group.Latitude.HasValue && _group.Longitude.HasValue)
                            {
                                <LeafletMap InitialLatitude="_group.Latitude.Value" InitialLongitude="_group.Longitude.Value"
                                    InitialZoom="15" MapStyle="height: 200px; width: 100%; border-radius: 8px;"
                                    OnMapInitialized="OnMapInitializedAsync" @ref="_leafletMap" />
                                <MudButton Href="@GetGoogleMapsUrl(_group.Latitude.Value, _group.Longitude.Value)" Target="_blank"
                                    Variant="Variant.Text" Size="Size.Small" StartIcon="@Icons.Material.Filled.Directions"
                                    Class="mt-2">
                                    Få rutevejledning
                                </MudButton>
                            }
                        }
                        else
                        {
                            @* Non-member view: Show only zip code area *@
                            <div class="d-flex align-center mb-3">
                                <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-2"
                                    Style="@($"color: {JordnaerPalette.BlueBody};")" />
                                <MudText Typo="Typo.body1">
                                    @FormatLocation(_group.City, _group.ZipCode)
                                </MudText>
                            </div>
                            <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense Class="mb-3">
                                Den præcise adresse vises kun for medlemmer.
                            </MudAlert>
                            @if (_group.ZipCodeLatitude.HasValue && _group.ZipCodeLongitude.HasValue)
                            {
                                <LeafletMap InitialLatitude="_group.ZipCodeLatitude.Value"
                                    InitialLongitude="_group.ZipCodeLongitude.Value" InitialZoom="12"
                                    MapStyle="height: 200px; width: 100%; border-radius: 8px;"
                                    OnMapInitialized="OnMapInitializedAsync" @ref="_leafletMap" />
                            }
                        }
                    }
                </MudPaper>

                <MudPaper Elevation="3" Class="overflow-hidden" Style="max-height: 500px; overflow-y: auto;">
                    <GroupMemberListComponent CurrentUserIsAdmin="_currentUserIsAdmin" GroupMembers="_groupMembers"
                        GroupName="@GroupName" />
                </MudPaper>
            </MudStack>
        </MudItem>

        <!-- Right Main Content: Description & Posts -->
        <MudItem xs="12" md="8">
            <MudStack Spacing="4">
                @if (!string.IsNullOrEmpty(_group?.Description))
                {
                    <MudPaper Elevation="3" Class="pa-6">
                        <MudText Typo="Typo.h6" Class="mb-4">Om gruppen</MudText>
                        <MudDivider Class="mb-4" />
                        @MarkdownRenderer.SanitizeAndRenderMarkupString(_group?.Description)
                    </MudPaper>
                }

                @if (_isMember && _group is not null)
                {
                    <div id="posts-section">
                        <MudStack Spacing="4">
                            <GroupPostForm GroupId="_group.Id"
                                OnPostCreated="@(async () => { if (_groupPostList is not null) await _groupPostList.RefreshPostsAsync(); })" />
                            <GroupPostList @ref="_groupPostList" GroupId="_group.Id" />
                        </MudStack>
                    </div>
                }
                else if (!_isMember && !_isLoading)
                {
                    <MudPaper Class="pa-8 d-flex flex-column align-center justify-center dashed-border">
                        <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Info" Class="mb-2" />
                        <MudText Typo="Typo.h6" Color="Color.Info">Lukket Gruppe</MudText>
                        <MudText Color="Color.Info">Du skal være medlem for at se opslag i denne gruppe.</MudText>
                    </MudPaper>
                }
            </MudStack>
        </MudItem>
    </MudGrid>
</MudLoading>

<style>
    .dashed-border {
        border: 2px dashed var(--mud-palette-divider);
    }
</style>

@code {
    [Parameter]
    public required string GroupName { get; set; }

    private string _groupNotFoundMessage => $"Vi fandt ingen gruppe ved navn {GroupName}, beklager!";

    private GroupSlim? _group;

    private bool _isLoading = true;
    private UserProfile? _currentUser;
    private bool _hasPendingMembershipRequest = false;
    private bool _hasPendingInvite = false;
    private bool _isMember = false;
    private bool _currentUserIsAdmin => _admins.Select(x => x.Id).Contains(_currentUser?.Id);
    private bool _currentUserIsOwner = false;
    private List<UserSlim> _recipients = [];
    private List<GroupMemberSlim>? _groupMembers;
    private List<UserSlim> _admins = [];
    private GroupPostList? _groupPostList;
    private LeafletMap? _leafletMap;
    private bool _markerAdded;
    private int _pendingRequestCount = 0;
    private bool _processingInvite = false;
    private bool _isAcceptingInvite = false;

    protected override async Task OnInitializedAsync()
    {
        // TODO: Speed up with ContinueWith and Task.WhenAll
        var response = await GroupService.GetSlimGroupByNameAsync(GroupName);
        response.Switch(
        groupSlim => _group = groupSlim,
        _ => { });

        if (_group is null)
        {
            _isLoading = false;
            return;
        }

        _currentUser = await ProfileCache.GetProfileAsync();
        if (_currentUser is null)
        {
            _groupMembers = await GroupService.GetGroupMembersWithRolesByPredicateAsync(x => x.GroupId == _group.Id &&
                                                                                                    x.MembershipStatus == MembershipStatus.Active);
            _isLoading = false;
            return;
        }

        _groupMembers = await GroupService.GetGroupMembersWithRolesByPredicateAsync(x => x.GroupId == _group.Id &&
                                                                                                x.MembershipStatus == MembershipStatus.Active);

        var currentUsersGroupMembership = await GroupService.GetCurrentUsersGroupMembershipAsync(_group.Id);

        _isMember = currentUsersGroupMembership?.MembershipStatus is MembershipStatus.Active;
        _hasPendingMembershipRequest = currentUsersGroupMembership?.MembershipStatus
        is MembershipStatus.PendingApprovalFromGroup
        or MembershipStatus.PendingApprovalFromUser;
        _hasPendingInvite = currentUsersGroupMembership?.MembershipStatus is MembershipStatus.PendingApprovalFromUser;
        _currentUserIsOwner = currentUsersGroupMembership?.OwnershipLevel is OwnershipLevel.Owner;

        _admins = await GroupService
        .GetGroupMembersByPredicateAsync(x =>
        x.GroupId == _group.Id &&
        x.PermissionLevel == PermissionLevel.Admin);

        _recipients = _admins.Concat([_currentUser.ToUserSlim()]).ToList();

        // Fetch pending membership count if user is admin
        if (_currentUserIsAdmin)
        {
            _pendingRequestCount = await GroupService.GetPendingMembershipCountAsync(_group.Id);
        }

        _isLoading = false;
    }

    private async Task RequestMembership()
    {
        var requestMembershipResponse = await MembershipService.RequestMembership(GroupName, CancellationToken);
        requestMembershipResponse.Switch(
        _ =>
        {
            Snackbar.Add("Anmodning sendt!", Severity.Success);
            _hasPendingMembershipRequest = true;
            StateHasChanged();
        },
        existingMembershipError => Snackbar.Add($"Nuværende medlems status: {existingMembershipError.Value}",
        Severity.Warning),
        error => Snackbar.Add(error.Value, Severity.Warning));
    }

    private async Task LeaveGroup()
    {
        var leaveResponse = await MembershipService.LeaveMembership(GroupName, CancellationToken);
        leaveResponse.Switch(
        _ =>
        {
            Snackbar.Add("Du har forladt gruppen", Severity.Success);
            _isMember = false;
            StateHasChanged();
        },
        error => Snackbar.Add(error.Value, Severity.Warning));
    }

    private async Task OpenInviteDialog()
    {
        if (_group is null || _currentUser is null)
        {
            return;
        }

        var parameters = new DialogParameters<Jordnaer.Features.Membership.InviteUserDialog>
        {
            { x => x.GroupId, _group.Id },
            { x => x.CurrentUserId, _currentUser.Id }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<Jordnaer.Features.Membership.InviteUserDialog>(
            "Invitér medlem",
            parameters,
            options);

        var result = await dialog.Result;

        // Refresh pending count if invitation was successful
        if (result is { Canceled: false } && _currentUserIsAdmin)
        {
            _pendingRequestCount = await GroupService.GetPendingMembershipCountAsync(_group.Id);
            StateHasChanged();
        }
    }

    private async Task AcceptInvite()
    {
        if (_group is null)
        {
            return;
        }

        _processingInvite = true;
        _isAcceptingInvite = true;

        var result = await MembershipService.AcceptGroupInviteAsync(_group.Id, CancellationToken);

        result.Switch(
            success =>
            {
                Snackbar.Add($"Du er nu medlem af {_group.Name}!", Severity.Success);
                _hasPendingInvite = false;
                _isMember = true;
                _hasPendingMembershipRequest = false;
                _processingInvite = false;
                _isAcceptingInvite = false;
                StateHasChanged();
            },
            error =>
            {
                Snackbar.Add(error.Value, Severity.Error);
                _processingInvite = false;
                _isAcceptingInvite = false;
                StateHasChanged();
            }
        );
    }

    private async Task DeclineInvite()
    {
        if (_group is null)
        {
            return;
        }

        _processingInvite = true;
        _isAcceptingInvite = false;

        var result = await MembershipService.DeclineGroupInviteAsync(_group.Id, CancellationToken);

        result.Switch(
            success =>
            {
                Snackbar.Add($"Invitationen til {_group.Name} er afvist.", Severity.Info);
                _hasPendingInvite = false;
                _hasPendingMembershipRequest = false;
                _processingInvite = false;
                StateHasChanged();
            },
            error =>
            {
                Snackbar.Add(error.Value, Severity.Error);
                _processingInvite = false;
                StateHasChanged();
            }
        );
    }

    private static string FormatLocation(string? city, int? zipCode)
    {
        if (!string.IsNullOrEmpty(city) && zipCode.HasValue)
        {
            return $"{city}, {zipCode}";
        }
        if (!string.IsNullOrEmpty(city))
        {
            return city;
        }
        if (zipCode.HasValue)
        {
            return zipCode.Value.ToString();
        }
        return "Ikke angivet";
    }

    private static string GetGoogleMapsUrl(double latitude, double longitude)
    {
        return
        $"https://www.google.com/maps/dir/?api=1&destination={latitude.ToString(System.Globalization.CultureInfo.InvariantCulture)},{longitude.ToString(System.Globalization.CultureInfo.InvariantCulture)}";
    }

    private async Task OnMapInitializedAsync()
    {
        // Skip if marker already added, no map, or no group data
        if (_markerAdded || _leafletMap is null || _group is null)
        {
            return;
        }

        _markerAdded = true;

        // Add marker to the map based on the current state
        if (string.IsNullOrEmpty(_group.Address))
        {
            // State 2: Zip code only
            if (_group.Latitude.HasValue && _group.Longitude.HasValue)
            {
                await _leafletMap.UpdateMarkerAsync(_group.Latitude.Value, _group.Longitude.Value);
            }
        }
        else if (_isMember)
        {
            // State 3 - Member: Show exact location
            if (_group.Latitude.HasValue && _group.Longitude.HasValue)
            {
                await _leafletMap.UpdateMarkerAsync(_group.Latitude.Value, _group.Longitude.Value);
            }
        }
        else
        {
            // State 3 - Non-member: Show zip code center
            if (_group.ZipCodeLatitude.HasValue && _group.ZipCodeLongitude.HasValue)
            {
                await _leafletMap.UpdateMarkerAsync(_group.ZipCodeLatitude.Value, _group.ZipCodeLongitude.Value);
            }
        }
    }
}