@page "/groups/{GroupName}/members"

@inject GroupService GroupService
@inject ISnackbar Snackbar
@inject CurrentUser CurrentUser
@inject IDialogService DialogService

@attribute [Authorize]

<MetadataComponent Title="@($"{GroupName} - Medlemmer")"
    Description="Her kan gruppens administratore godkende nye medlemmer, give medlemmer yderligere adgang og lignende." />

<MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
    <BackButton />
    <MudText Typo="Typo.h4">Medlems oversigt for gruppen '@GroupName'</MudText>
</MudStack>

<MudDivider Class="mb-5" />

@* Toolbar *@
<MudPaper Class="mb-3 pa-3">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
        <MudText Typo="Typo.h6">Medlemmer (@_filteredMemberships.Count())</MudText>

        @if (_pendingCount > 0)
        {
            <MudBadge Content="_pendingCount" Color="Color.Warning" Overlap="true">
                <MudIcon Icon="@Icons.Material.Filled.PersonAdd" />
            </MudBadge>
        }

        <MudSpacer />

        <MudTextField @bind-Value="_searchString"
                      Placeholder="Søg medlemmer..."
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      IconSize="Size.Small"
                      Margin="Margin.Dense"
                      Immediate="true"
                      Class="mt-0" />
    </MudStack>
</MudPaper>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    @* Desktop Table - Hidden on mobile *@
    <MudHidden Breakpoint="Breakpoint.SmAndDown">
        <MudTable T="GroupMembershipDto"
                  Items="_filteredMemberships"
                  Hover="true"
                  Bordered="true"
                  Dense="true">
            <HeaderContent>
                <MudTh Style="@HeaderStyles">Navn</MudTh>
                <MudTh Style="@HeaderStyles">Ejerskabs Niveau</MudTh>
                <MudTh Style="@HeaderStyles">Adgangs Niveau</MudTh>
                <MudTh Style="@HeaderStyles">Status</MudTh>
                <MudTh Style="@HeaderStyles">Handlinger</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Navn">@context.UserDisplayName</MudTd>
                <MudTd DataLabel="Ejerskabs Niveau">
                    <MudChip T="string"
                             Size="Size.Small"
                             Color="@(context.OwnershipLevel == OwnershipLevel.Owner ? Color.Primary : Color.Default)">
                        @context.OwnershipLevel.ToDisplayName()
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Adgangs Niveau">
                    <MudChip T="string"
                             Size="Size.Small"
                             Color="@GetPermissionLevelColor(context.PermissionLevel)">
                        @context.PermissionLevel.ToDisplayName()
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string"
                             Size="Size.Small"
                             Color="@GetMembershipStatusColor(context.MembershipStatus)">
                        @GetMembershipStatusText(context.MembershipStatus)
                    </MudChip>
                </MudTd>
                <MudTd>
                    @if (CanEditUser(context))
                    {
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                            <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                                         OnClick="@(() => OpenEditDialog(context))">
                                Rediger Rettigheder
                            </MudMenuItem>

                            @if (context.MembershipStatus == MembershipStatus.PendingApprovalFromGroup)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.Check"
                                             OnClick="@(() => ApproveMember(context))">
                                    Godkend
                                </MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Filled.Close"
                                             OnClick="@(() => RejectMember(context))">
                                    Afvis
                                </MudMenuItem>
                            }
                            else if (context.MembershipStatus == MembershipStatus.Active)
                            {
                                <MudDivider />
                                <MudMenuItem Icon="@Icons.Material.Filled.PersonRemove"
                                             OnClick="@(() => RemoveMember(context))">
                                    Fjern Medlem
                                </MudMenuItem>
                            }
                            else if (context.MembershipStatus == MembershipStatus.Rejected)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.PersonAdd"
                                             OnClick="@(() => AddMember(context))">
                                    Tilføj Medlem
                                </MudMenuItem>
                            }
                        </MudMenu>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudHidden>

    @* Mobile List - Hidden on desktop *@
    <MudHidden Breakpoint="Breakpoint.MdAndUp">
        <MudList T="string" Dense="true">
            @foreach (var member in _filteredMemberships)
            {
                <MudListItem T="string">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Spacing="1" Class="pa-2">
                        <MudStack Spacing="1" Style="flex: 1;">
                            <MudText Typo="Typo.body1"><strong>@member.UserDisplayName</strong></MudText>
                            <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                                <MudChip T="string"
                                         Size="Size.Small"
                                         Color="@GetMembershipStatusColor(member.MembershipStatus)">
                                    @GetMembershipStatusText(member.MembershipStatus)
                                </MudChip>
                                <MudChip T="string"
                                         Size="Size.Small"
                                         Color="@(member.OwnershipLevel == OwnershipLevel.Owner ? Color.Primary : Color.Default)">
                                    @member.OwnershipLevel.ToDisplayName()
                                </MudChip>
                                <MudChip T="string"
                                         Size="Size.Small"
                                         Color="@GetPermissionLevelColor(member.PermissionLevel)">
                                    @member.PermissionLevel.ToDisplayName()
                                </MudChip>
                            </MudStack>
                        </MudStack>
                        @if (CanEditUser(member))
                        {
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                                <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                                             OnClick="@(() => OpenEditDialog(member))">
                                    Rediger Rettigheder
                                </MudMenuItem>

                                @if (member.MembershipStatus == MembershipStatus.PendingApprovalFromGroup)
                                {
                                    <MudMenuItem Icon="@Icons.Material.Filled.Check"
                                                 OnClick="@(() => ApproveMember(member))">
                                        Godkend
                                    </MudMenuItem>
                                    <MudMenuItem Icon="@Icons.Material.Filled.Close"
                                                 OnClick="@(() => RejectMember(member))">
                                        Afvis
                                    </MudMenuItem>
                                }
                                else if (member.MembershipStatus == MembershipStatus.Active)
                                {
                                    <MudDivider />
                                    <MudMenuItem Icon="@Icons.Material.Filled.PersonRemove"
                                                 OnClick="@(() => RemoveMember(member))">
                                        Fjern Medlem
                                    </MudMenuItem>
                                }
                                else if (member.MembershipStatus == MembershipStatus.Rejected)
                                {
                                    <MudMenuItem Icon="@Icons.Material.Filled.PersonAdd"
                                                 OnClick="@(() => AddMember(member))">
                                        Tilføj Medlem
                                    </MudMenuItem>
                                }
                            </MudMenu>
                        }
                    </MudStack>
                </MudListItem>
                <MudDivider />
            }
        </MudList>
    </MudHidden>
}

@* Edit Permissions Dialog *@
<MudDialog @bind-Visible="_editDialogVisible" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
            Rediger Rettigheder for @_editingMember?.UserDisplayName
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            @if (_editingMember != null)
            {
                <MudSelect @bind-Value="_editingMember.OwnershipLevel"
                           Label="Ejerskabs Niveau"
                           HelperText="Bestemmer ejerskabsrettigheder i gruppen">
                    @foreach (var level in Enum.GetValues<OwnershipLevel>())
                    {
                        <MudSelectItem Value="level">
                            @level.ToDisplayName()
                        </MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="_editingMember.PermissionLevel"
                           Label="Adgangs Niveau"
                           HelperText="Kontrollerer hvilke handlinger medlemmet kan udføre">
                    @foreach (var level in Enum.GetValues<PermissionLevel>())
                    {
                        <MudSelectItem Value="level">
                            @level.ToDisplayName()
                        </MudSelectItem>
                    }
                </MudSelect>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelEdit">Annuller</MudButton>
        <MudButton Color="Color.Info"
                   Variant="Variant.Filled"
                   OnClick="SaveEdit">
            Gem Ændringer
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private static readonly Dictionary<MembershipStatus, int> SortOrder = new()
    {
        {MembershipStatus.PendingApprovalFromGroup, 0},
        {MembershipStatus.PendingApprovalFromUser, 1},
        {MembershipStatus.Active, 2},
        {MembershipStatus.Rejected, 3}
    };

    private List<GroupMembershipDto> _memberships = [];
    private bool _isLoading = true;
    private bool _hasAccess;
    private const string HeaderStyles = "font-weight: 800; font-size: 1.2rem;";

    // Search and filtering
    private string _searchString = "";
    private int _pendingCount => _memberships.Count(m => m.MembershipStatus == MembershipStatus.PendingApprovalFromGroup);

    private IEnumerable<GroupMembershipDto> _filteredMemberships
    {
        get
        {
            if (string.IsNullOrWhiteSpace(_searchString))
                return _memberships;

            return _memberships.Where(m => m.UserDisplayName.Contains(_searchString, StringComparison.OrdinalIgnoreCase));
        }
    }

    // Edit dialog
    private bool _editDialogVisible;
    private GroupMembershipDto? _editingMember;
    private OwnershipLevel _originalOwnershipLevel;
    private PermissionLevel _originalPermissionLevel;

    private DialogOptions _dialogOptions = new()
    {
        CloseOnEscapeKey = true,
        MaxWidth = MaxWidth.Small,
        FullWidth = true
    };

    [Parameter]
    public required string GroupName { get; set; }

    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _memberships = await GroupService.GetGroupMembershipsAsync(GroupName);

            var currentUserMembership = _memberships.FirstOrDefault(m => m.UserProfileId == CurrentUser.Id);
            _hasAccess = currentUserMembership is { PermissionLevel: PermissionLevel.Admin } or { OwnershipLevel: OwnershipLevel.Owner };

            if (!_hasAccess)
            {
                Snackbar.Add("Du har ikke adgang til denne side.", Severity.Error);
                NavigationManager.NavigateTo($"/groups/{GroupName}");
                return;
            }

            _memberships = _memberships
                .OrderBy(x => SortOrder.TryGetValue(x.MembershipStatus, out var rank) ? rank : int.MaxValue)
                .ToList();
        }
        catch (Exception)
        {
            Snackbar.Add("Kunne ikke hente medlemmer. Prøv igen.", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private bool CanEditUser(GroupMembershipDto member)
    {
        return member.UserProfileId != CurrentUser.Id && member.OwnershipLevel != OwnershipLevel.Owner;
    }

    private Color GetPermissionLevelColor(PermissionLevel level) => level switch
    {
        PermissionLevel.Admin => Color.Success,
        PermissionLevel.Write => Color.Info,
        _ => Color.Default
    };

    private Color GetMembershipStatusColor(MembershipStatus status) => status switch
    {
        MembershipStatus.PendingApprovalFromGroup => Color.Warning,
        MembershipStatus.Active => Color.Success,
        MembershipStatus.Rejected => Color.Default,
        MembershipStatus.PendingApprovalFromUser => Color.Info,
        _ => Color.Default
    };

    private string GetMembershipStatusText(MembershipStatus status) => status switch
    {
        MembershipStatus.Active => "Medlem",
        MembershipStatus.PendingApprovalFromUser => "Afventer godkendelse",
        MembershipStatus.PendingApprovalFromGroup => "Afventer gruppens godkendelse",
        MembershipStatus.Rejected => "Ikke medlem",
        _ => "Ukendt status"
    };

    // Edit Dialog Methods
    private void OpenEditDialog(GroupMembershipDto member)
    {
        _editingMember = member;
        _originalOwnershipLevel = member.OwnershipLevel;
        _originalPermissionLevel = member.PermissionLevel;
        _editDialogVisible = true;
    }

    private void CancelEdit()
    {
        if (_editingMember != null)
        {
            _editingMember.OwnershipLevel = _originalOwnershipLevel;
            _editingMember.PermissionLevel = _originalPermissionLevel;
        }
        _editDialogVisible = false;
        _editingMember = null;
    }

    private async Task SaveEdit()
    {
        if (_editingMember == null) return;

        var success = await SaveChangesAsync(_editingMember);
        if (success)
        {
            _editDialogVisible = false;
            _editingMember = null;
        }
        else
        {
            _editingMember.OwnershipLevel = _originalOwnershipLevel;
            _editingMember.PermissionLevel = _originalPermissionLevel;
        }
    }

    // Membership Status Change Methods
    private async Task ApproveMember(GroupMembershipDto member)
    {
        await ChangeMembershipStatusAsync(member, MembershipStatus.Active);
    }

    private async Task RejectMember(GroupMembershipDto member)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Afvis Medlem",
            $"Er du sikker på, at du vil afvise {member.UserDisplayName}?",
            yesText: "Afvis",
            cancelText: "Annuller");

        if (result == true)
        {
            await ChangeMembershipStatusAsync(member, MembershipStatus.Rejected);
        }
    }

    private async Task RemoveMember(GroupMembershipDto member)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Fjern Medlem",
            $"Er du sikker på, at du vil fjerne {member.UserDisplayName} fra gruppen?",
            yesText: "Fjern",
            cancelText: "Annuller");

        if (result == true)
        {
            await ChangeMembershipStatusAsync(member, MembershipStatus.Rejected);
        }
    }

    private async Task AddMember(GroupMembershipDto member)
    {
        await ChangeMembershipStatusAsync(member, MembershipStatus.Active);
    }

    private async Task ChangeMembershipStatusAsync(GroupMembershipDto membership, MembershipStatus newStatus)
    {
        var previous = membership.MembershipStatus;
        if (membership.OwnershipLevel is OwnershipLevel.Owner && newStatus is MembershipStatus.Rejected)
        {
            Snackbar.Add("Du kan ikke fjerne gruppeejeren.", Severity.Warning);
            return;
        }

        membership.MembershipStatus = newStatus;
        var success = await SaveChangesAsync(membership);
        if (!success)
        {
            membership.MembershipStatus = previous;
        }
    }

    private async Task<bool> SaveChangesAsync(GroupMembershipDto item, bool showSnackbar = true)
    {
        try
        {
            var updateResult = await GroupService.UpdateMembership(item);
            var updateSuccessful = false;
            updateResult.Switch(
                success =>
                {
                    if (showSnackbar)
                    {
                        Snackbar.Add($"{item.UserDisplayName}'s medlemskab blev opdateret.", Severity.Success);
                    }
                    updateSuccessful = true;
                },
                error =>
                {
                    if (showSnackbar)
                    {
                        Snackbar.Add(error.Value, Severity.Error);
                    }
                });
            return updateSuccessful;
        }
        catch (Exception)
        {
            if (showSnackbar)
            {
                Snackbar.Add("Der skete en fejl under opdatering. Prøv igen.", Severity.Error);
            }
            return false;
        }
    }
}
