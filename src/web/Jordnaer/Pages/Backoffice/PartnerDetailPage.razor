@page "/backoffice/partners/{id:guid}"

@inject IPartnerService PartnerService
@inject IPartnerUserService PartnerUserService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject ILogger<PartnerDetailPage> Logger

@attribute [Authorize(Policy = AuthorizationPolicies.AdminOnly)]

<MetadataComponent Title="Backoffice - Partner Detaljer"
    Description="Se og administrer partner detaljer og annoncer." />

<MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                   Color="Color.Primary"
                   OnClick="NavigateBack" />
    <MudText Typo="Typo.h4">Partner Detaljer</MudText>
</MudStack>

<MudDivider Class="mb-5" />

@if (_loading)
{
    <MudProgressCircular Indeterminate Color="Color.Primary" />
}
else if (_partner is null)
{
    <MudAlert Severity="Severity.Warning">Partner ikke fundet.</MudAlert>
}
else
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
        @* Partner Information Card *@
        <MudPaper Class="pa-6 mb-8" Elevation="2">
            <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
                <MudText Typo="Typo.h5" Class="font-open-sans-bold"
                         Style="@JordnaerPalette.YellowBackground.ToTextColor()">
                    Partner Information
                </MudText>
                <MudStack Row Spacing="2">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Email"
                               OnClick="ResendWelcomeEmailAsync"
                               Disabled="_processing">
                        Gensend Velkomst-email
                    </MudButton>
                    @if (!_isEditing)
                    {
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Edit"
                                   OnClick="StartEditing">
                            Rediger
                        </MudButton>
                    }
                </MudStack>
            </MudStack>

            @if (_isEditing)
            {
                <EditForm Model="@_editModel" OnValidSubmit="SaveChangesAsync">
                    <DataAnnotationsValidator />

                    <MudStack Spacing="4">
                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_editModel.Name"
                                              Label="Navn"
                                              Variant="Variant.Outlined"
                                              HelperText="Navnet på virksomheden eller partneren"
                                              MaxLength="128" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Bruger ID</MudText>
                                    <MudText Typo="Typo.body2">@_partner.UserId</MudText>
                                </MudStack>
                            </MudItem>

                            <MudItem xs="12">
                                <MudTextField @bind-Value="_editModel.Description"
                                              Label="Beskrivelse"
                                              Variant="Variant.Outlined"
                                              Lines="4"
                                              HelperText="Kort beskrivelse af partneren"
                                              MaxLength="500" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_editModel.PartnerPageLink"
                                              Label="Partnerside Link"
                                              Variant="Variant.Outlined"
                                              HelperText="Partnernes hjemmeside (fx https://example.com)"
                                              InputType="InputType.Url" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_editModel.AdLink"
                                              Label="Annonce Link"
                                              Variant="Variant.Outlined"
                                              HelperText="Link der åbnes ved klik på annoncen"
                                              InputType="InputType.Url" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_editModel.AdLabelColor"
                                              Label="Annonce Label Farve"
                                              Variant="Variant.Outlined"
                                              HelperText="Hex farve som #FFFFFF (tom = standard)"
                                              MaxLength="7" />
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-2" />

                        <MudText Typo="Typo.h6" Class="mb-2">Tilladelser</MudText>

                        <MudSwitch @bind-Value="_editModel.CanHavePartnerCard"
                                   Label="Tillad Partner Kort"
                                   Color="Color.Primary"
                                   Class="mb-2" />
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3 ml-10">
                            Hvis aktiveret, kan partneren vises på /partners siden med logo og beskrivelse
                        </MudText>

                        <MudSwitch @bind-Value="_editModel.CanHaveAd"
                                   Label="Tillad Annoncer"
                                   Color="Color.Primary"
                                   Class="mb-2" />
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3 ml-10">
                            Hvis aktiveret, kan partneren uploade annonce billeder der vises i søgeresultater
                        </MudText>

                        <MudDivider Class="my-2" />

                        <MudText Typo="Typo.h6" Class="mb-2">Visningsperiode</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                            Angiv en tidsperiode hvor partnerens annoncer og kort vises. Lad felterne stå tomme for ingen begrænsning.
                        </MudText>

                        <MudGrid Spacing="3">
                            <MudItem xs="12" md="6">
                                <MudDatePicker @bind-Date="_editModel.DisplayStartDate"
                                               Label="Startdato (UTC)"
                                               Variant="Variant.Outlined"
                                               Clearable
                                               HelperText="Hvornår skal partneren begynde at blive vist? (tom = ingen begrænsning)" />
                            </MudItem>

                            <MudItem xs="12" md="6">
                                <MudDatePicker @bind-Date="_editModel.DisplayEndDate"
                                               Label="Slutdato (UTC)"
                                               Variant="Variant.Outlined"
                                               Clearable
                                               HelperText="Hvornår skal partneren stoppe med at blive vist? (tom = ingen begrænsning)" />
                            </MudItem>
                        </MudGrid>

                        <MudDivider Class="my-2" />

                        <MudItem xs="12" md="6">
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Oprettet</MudText>
                                <MudText Typo="Typo.body1">@_partner.CreatedUtc.ToString("dd/MM/yyyy HH:mm")</MudText>
                            </MudStack>
                        </MudItem>

                        @if (_partner.LastUpdateUtc.HasValue)
                        {
                            <MudItem xs="12" md="6">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Sidste opdatering</MudText>
                                    <MudText Typo="Typo.body1">@_partner.LastUpdateUtc.Value.ToString("dd/MM/yyyy HH:mm")</MudText>
                                </MudStack>
                            </MudItem>
                        }

                        <MudStack Row Spacing="3" Justify="Justify.FlexEnd" Class="mt-4">
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Default"
                                       OnClick="CancelEditing"
                                       Disabled="_processing">
                                Annuller
                            </MudButton>

                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       ButtonType="ButtonType.Submit"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       Disabled="_processing">
                                @if (_processing)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate Class="mr-2" />
                                    <text>Gemmer...</text>
                                }
                                else
                                {
                                    <text>Gem Ændringer</text>
                                }
                            </MudButton>
                        </MudStack>
                    </MudStack>
                </EditForm>
            }
            else
            {
                <MudGrid Spacing="3">
                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Navn</MudText>
                            <MudText Typo="Typo.body1">@(_partner.Name ?? "Ikke angivet")</MudText>
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Bruger ID</MudText>
                            <MudText Typo="Typo.body2">@_partner.UserId</MudText>
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Beskrivelse</MudText>
                            <MudText Typo="Typo.body1">@(_partner.Description ?? "Ikke angivet")</MudText>
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Partnerside Link</MudText>
                            @if (!string.IsNullOrWhiteSpace(_partner.PartnerPageLink))
                            {
                                <MudLink Href="@_partner.PartnerPageLink" Target="_blank" rel="noopener" Typo="Typo.body1">
                                    @_partner.PartnerPageLink
                                </MudLink>
                            }
                            else
                            {
                                <MudText Typo="Typo.body1" Color="Color.Secondary">Ingen side angivet</MudText>
                            }
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Annonce Link</MudText>
                            @if (!string.IsNullOrEmpty(_partner.AdLink))
                            {
                                <MudLink Href="@_partner.AdLink" Target="_blank" rel="noopener" Typo="Typo.body1">
                                    @_partner.AdLink
                                </MudLink>
                            }
                            else
                            {
                                <MudText Typo="Typo.body1" Color="Color.Secondary">Ingen annonce link angivet</MudText>
                            }
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Annonce Label Farve</MudText>
                            @if (!string.IsNullOrEmpty(_partner.AdLabelColor))
                            {
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                    <div style="width: 24px; height: 24px; border-radius: 4px; background-color: @_partner.AdLabelColor; border: 1px solid #ccc;"></div>
                                    <MudText Typo="Typo.body1">@_partner.AdLabelColor</MudText>
                                </MudStack>
                            }
                            else
                            {
                                <MudText Typo="Typo.body1" Color="Color.Secondary">Standard</MudText>
                            }
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Oprettet</MudText>
                            <MudText Typo="Typo.body1">@_partner.CreatedUtc.ToString("dd/MM/yyyy HH:mm")</MudText>
                        </MudStack>
                    </MudItem>

                    @if (_partner.LastUpdateUtc.HasValue)
                    {
                        <MudItem xs="12" md="6">
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Sidste opdatering</MudText>
                                <MudText Typo="Typo.body1">@_partner.LastUpdateUtc.Value.ToString("dd/MM/yyyy HH:mm")</MudText>
                            </MudStack>
                        </MudItem>
                    }

                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Tilladelser</MudText>
                            <MudStack Row Spacing="2">
                                <MudChip T="string" Size="Size.Small"
                                         Color="@(_partner.CanHavePartnerCard ? Color.Success : Color.Default)"
                                         Icon="@(_partner.CanHavePartnerCard ? Icons.Material.Filled.Check : Icons.Material.Filled.Close)">
                                    Partner Kort
                                </MudChip>
                                <MudChip T="string" Size="Size.Small"
                                         Color="@(_partner.CanHaveAd ? Color.Success : Color.Default)"
                                         Icon="@(_partner.CanHaveAd ? Icons.Material.Filled.Check : Icons.Material.Filled.Close)">
                                    Annoncer
                                </MudChip>
                            </MudStack>
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Visningsperiode</MudText>
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body1">
                                    Fra: @(_partner.DisplayStartUtc.HasValue ? _partner.DisplayStartUtc.Value.ToString("dd/MM/yyyy HH:mm") + " UTC" : "Ingen begrænsning")
                                </MudText>
                                <MudText Typo="Typo.body1">
                                    Til: @(_partner.DisplayEndUtc.HasValue ? _partner.DisplayEndUtc.Value.ToString("dd/MM/yyyy HH:mm") + " UTC" : "Ingen begrænsning")
                                </MudText>
                                @{
                                    var isActive = _partner.IsWithinDisplayWindow(DateTime.UtcNow);
                                }
                                <MudChip T="string" Size="Size.Small"
                                         Color="@(isActive ? Color.Success : Color.Error)"
                                         Icon="@(isActive ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)">
                                    @(isActive ? "Aktiv" : "Ikke synlig")
                                </MudChip>
                            </MudStack>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            }
        </MudPaper>

        @* Pending Changes Approval Section *@
        @if (_partner.HasPendingApproval)
        {
            <MudPaper Class="pa-6 mb-8" Elevation="2">
                <MudText Typo="Typo.h5" Class="mb-4 font-open-sans-bold"
                         Style="@JordnaerPalette.YellowBackground.ToTextColor()">
                    Afventende Ændringer
                </MudText>

                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    Disse ændringer afventer din godkendelse
                </MudAlert>

                @* Pending Ad Image - Side by Side *@
                @if (!string.IsNullOrEmpty(_partner.PendingAdImageUrl))
                {
                    <MudPaper Class="pa-4 mb-6" Elevation="1">
                        <MudText Typo="Typo.h6" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Image" Class="mr-2" /> Annonce Billede
                        </MudText>
                        <MudGrid Spacing="4">
                            <MudItem xs="12" md="6">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Nuværende</MudText>
                                    @if (!string.IsNullOrEmpty(_partner.AdImageUrl))
                                    {
                                        <div style="max-width: 300px;">
                                            <AdCard Link="@(_partner.AdLink ?? _partner.PartnerPageLink)"
                                                ImagePath="@_partner.AdImageUrl"
                                                ImageAlt="@(_partner.Name + " annonce")"
                                                LabelColor="@_partner.AdLabelColor"
                                                IsPreview="true" />
                                        </div>
                                    }
                                    else
                                    {
                                        <MudAlert Severity="Severity.Info" Dense>Intet billede</MudAlert>
                                    }
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle2" Style="color: #ff9800;">Afventer godkendelse</MudText>
                                    <div style="max-width: 300px;">
                                        <AdCard Link="@(_partner.PendingAdLink ?? _partner.AdLink ?? _partner.PendingPartnerPageLink ?? _partner.PartnerPageLink)"
                                            ImagePath="@_partner.PendingAdImageUrl"
                                            ImageAlt="@(_partner.Name + " annonce")"
                                            LabelColor="@(_partner.PendingAdLabelColor ?? _partner.AdLabelColor)"
                                            IsPreview="true" />
                                    </div>
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                }

                @* Pending Partner Card - Side by Side *@
                @if (HasPendingPartnerCardChanges())
                {
                    <MudPaper Class="pa-4 mb-6" Elevation="1">
                        <MudText Typo="Typo.h6" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" /> Partner Kort
                        </MudText>
                        <MudGrid Spacing="4">
                            <MudItem xs="12" md="6">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Nuværende</MudText>
                                    <div style="max-width: 300px;">
                                        <PartnerCard Partner="@GetCurrentPartner()" IsPreview="true" />
                                    </div>
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudStack Spacing="2">
                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                        <MudText Typo="Typo.subtitle2" Style="color: #ff9800;">Afventer godkendelse</MudText>
                                        @if (HasPendingTextChanges())
                                        {
                                            <MudTooltip Text="@GetPendingChangesText()">
                                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Warning" />
                                            </MudTooltip>
                                        }
                                    </MudStack>
                                    <div style="max-width: 300px;">
                                        <PartnerCard Partner="@GetPendingPartner()" IsPreview="true" />
                                    </div>
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                }

                <MudStack Row Spacing="3" Class="mt-6">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               StartIcon="@Icons.Material.Filled.Check"
                               OnClick="ApproveChangesAsync"
                               Disabled="_processing">
                        @if (_processing)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate />
                            <MudText Class="ml-2">Godkender...</MudText>
                        }
                        else
                        {
                            <text>Godkend Ændringer</text>
                        }
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Error"
                               StartIcon="@Icons.Material.Filled.Close"
                               OnClick="RejectChangesAsync"
                               Disabled="_processing">
                        @if (_processing)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate />
                            <MudText Class="ml-2">Afviser...</MudText>
                        }
                        else
                        {
                            <text>Afvis Ændringer</text>
                        }
                    </MudButton>
                </MudStack>
            </MudPaper>
        }

        @* Current Assets Section *@
        <MudPaper Class="pa-6 mb-8" Elevation="2">
            <MudText Typo="Typo.h5" Class="mb-4 font-open-sans-bold"
                     Style="@JordnaerPalette.YellowBackground.ToTextColor()">
                Nuværende Billeder
            </MudText>

            <MudGrid Spacing="4">
                @if (!string.IsNullOrEmpty(_partner.AdImageUrl))
                {
                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1" Class="font-open-sans-bold">
                                <MudIcon Icon="@Icons.Material.Filled.Image" Class="mr-2" /> Annonce Billede
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Sådan vises annoncen i søgeresultater
                            </MudText>
                            <div style="max-width: 300px;">
                                <AdCard Link="@(_partner.AdLink ?? _partner.PartnerPageLink)"
                                    ImagePath="@_partner.AdImageUrl"
                                    ImageAlt="@(_partner.Name + " annonce")"
                                    LabelColor="@_partner.AdLabelColor"
                                    IsPreview="true" />
                            </div>
                        </MudStack>
                    </MudItem>
                }

                @if (!string.IsNullOrEmpty(_partner.LogoUrl) || !string.IsNullOrEmpty(_partner.Description))
                {
                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1" Class="font-open-sans-bold">
                                <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" /> Partner Kort
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Sådan vises partneren på partnersiden
                            </MudText>
                            <div style="max-width: 300px;">
                                <PartnerCard Partner="@GetCurrentPartner()" IsPreview="true" />
                            </div>
                        </MudStack>
                    </MudItem>
                }

                @if (string.IsNullOrEmpty(_partner.AdImageUrl) && string.IsNullOrEmpty(_partner.LogoUrl))
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info">Ingen billeder uploadet endnu</MudAlert>
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>

        @* Time Period Selector for Analytics *@
        <MudPaper Class="pa-4 mb-6" Elevation="2">
            <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h6">Tidsperiode:</MudText>
                <MudButtonGroup Variant="Variant.Outlined" Color="Color.Primary">
                    <MudButton OnClick="() => SelectTimePeriod(7)"
                        Variant="@(_selectedDays == 7 ? Variant.Filled : Variant.Outlined)">
                        7 dage
                    </MudButton>
                    <MudButton OnClick="() => SelectTimePeriod(30)"
                        Variant="@(_selectedDays == 30 ? Variant.Filled : Variant.Outlined)">
                        30 dage
                    </MudButton>
                    <MudButton OnClick="() => SelectTimePeriod(90)"
                        Variant="@(_selectedDays == 90 ? Variant.Filled : Variant.Outlined)">
                        90 dage
                    </MudButton>
                    <MudButton OnClick="() => SelectTimePeriod(365)"
                        Variant="@(_selectedDays == 365 ? Variant.Filled : Variant.Outlined)">
                        365 dage
                    </MudButton>
                </MudButtonGroup>
            </MudStack>
        </MudPaper>

        @* Analytics Cards Grid *@
        <MudGrid Spacing="6" Class="mb-8">
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="2">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary" />
                                <MudText Typo="Typo.h6">Impressions</MudText>
                            </MudStack>
                            <MudText Typo="Typo.h3" Class="font-open-sans-bold">
                                @_analytics?.TotalImpressions.ToString("N0")
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Antal gange annoncen er vist
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="2">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.TouchApp" Color="Color.Success" />
                                <MudText Typo="Typo.h6">Clicks</MudText>
                            </MudStack>
                            <MudText Typo="Typo.h3" Class="font-open-sans-bold">
                                @_analytics?.TotalClicks.ToString("N0")
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Antal gange der er klikket på annoncen
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="2">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Info" />
                                <MudText Typo="Typo.h6">CTR</MudText>
                            </MudStack>
                            <MudText Typo="Typo.h3" Class="font-open-sans-bold">
                                @(_analytics is not null ? $"{_analytics.ClickThroughRate:F2}%" : string.Empty)
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Click-through rate
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        @* Analytics Chart *@
        <PartnerAnalyticsDisplay Analytics="_analytics" ChartSeries="_chartSeries" XAxisLabels="_xAxisLabels" />
    </MudContainer>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private Partner? _partner;
    private PartnerAnalyticsDto? _analytics;
    private bool _loading = true;
    private bool _processing = false;
    private bool _isEditing = false;
    private int _selectedDays = 30;
    private EditPartnerModel _editModel = new();

    private List<ChartSeries> _chartSeries = [];
    private string[] _xAxisLabels = [];

    private class EditPartnerModel
    {
        public string? Name { get; set; }
        public string? Description { get; set; }
        public string? PartnerPageLink { get; set; }
        public string? AdLink { get; set; }
        public string? AdLabelColor { get; set; }
        public bool CanHavePartnerCard { get; set; } = true;
        public bool CanHaveAd { get; set; } = true;
        public DateTime? DisplayStartDate { get; set; }
        public DateTime? DisplayEndDate { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadPartnerDataAsync();
            await LoadAnalyticsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load partner details for {PartnerId}", Id);
            Snackbar.Add("Kunne ikke hente partner data. Prøv igen senere.", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadPartnerDataAsync()
    {
        var result = await PartnerService.GetPartnerByIdAsync(Id);
        result.Switch(
            partner => _partner = partner,
            notFound =>
            {
                _partner = null;
                Snackbar.Add("Partner ikke fundet", Severity.Warning);
            }
        );
    }

    private void StartEditing()
    {
        if (_partner is null) return;

        _editModel = new EditPartnerModel
        {
            Name = _partner.Name,
            Description = _partner.Description,
            PartnerPageLink = _partner.PartnerPageLink,
            AdLink = _partner.AdLink,
            AdLabelColor = _partner.AdLabelColor,
            CanHavePartnerCard = _partner.CanHavePartnerCard,
            CanHaveAd = _partner.CanHaveAd,
            DisplayStartDate = _partner.DisplayStartUtc,
            DisplayEndDate = _partner.DisplayEndUtc
        };
        _isEditing = true;
    }

    private void CancelEditing()
    {
        _isEditing = false;
    }

    private async Task SaveChangesAsync()
    {
        if (_partner is null) return;

        _processing = true;
        try
        {
            var request = new UpdatePartnerRequest
            {
                Name = _editModel.Name,
                Description = _editModel.Description,
                PartnerPageLink = _editModel.PartnerPageLink,
                AdLink = _editModel.AdLink,
                AdLabelColor = _editModel.AdLabelColor,
                CanHavePartnerCard = _editModel.CanHavePartnerCard,
                CanHaveAd = _editModel.CanHaveAd,
                DisplayStartUtc = _editModel.DisplayStartDate.HasValue
                    ? DateTime.SpecifyKind(_editModel.DisplayStartDate.Value, DateTimeKind.Utc)
                    : null,
                DisplayEndUtc = _editModel.DisplayEndDate.HasValue
                    ? DateTime.SpecifyKind(_editModel.DisplayEndDate.Value.Date.AddDays(1).AddTicks(-1), DateTimeKind.Utc)
                    : null
            };

            var result = await PartnerService.UpdatePartnerAsync(_partner.Id, request);

            result.Switch(
                success =>
                {
                    Snackbar.Add("Partner opdateret!", Severity.Success);
                    _isEditing = false;
                },
                notFound =>
                {
                    Snackbar.Add("Partner ikke fundet", Severity.Warning);
                },
                error => Snackbar.Add(error.Value, Severity.Error)
            );

            await LoadPartnerDataAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save partner changes for {PartnerId}", _partner.Id);
            Snackbar.Add("Kunne ikke gemme ændringer. Prøv igen senere.", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task ResendWelcomeEmailAsync()
    {
        if (_partner is null) return;

        _processing = true;
        try
        {
            var result = await PartnerUserService.ResendWelcomeEmailAsync(_partner.UserId);

            result.Switch(
                success => Snackbar.Add("Velkomst-email sendt med nyt midlertidigt kodeord!", Severity.Success),
                notFound => Snackbar.Add("Partner bruger ikke fundet", Severity.Warning),
                error => Snackbar.Add(error.Value, Severity.Error)
            );
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to resend welcome email for partner {PartnerId}", _partner.Id);
            Snackbar.Add("Kunne ikke sende velkomst-email. Prøv igen senere.", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task LoadAnalyticsAsync()
    {
        if (_partner is null)
        {
            return;
        }

        var toDate = DateTime.UtcNow;
        var fromDate = toDate.AddDays(-_selectedDays);

        var result = await PartnerService.GetAnalyticsAsync(_partner.Id, fromDate, toDate);
        result.Switch(
            analytics =>
            {
                _analytics = analytics;

                // Update chart data
                if (_analytics?.DailyAnalytics?.Any() == true)
                {
                    _xAxisLabels = _analytics.DailyAnalytics.Select(a => a.Date.ToString("dd/MM")).ToArray();

                    _chartSeries =
                    [
                        new ChartSeries
                        {
                            Name = "Impressions",
                            Data = _analytics.DailyAnalytics.Select(a => (double)a.Impressions).ToArray()
                        },
                        new ChartSeries
                        {
                            Name = "Clicks",
                            Data = _analytics.DailyAnalytics.Select(a => (double)a.Clicks).ToArray()
                        }
                    ];
                }
                else
                {
                    _xAxisLabels = [];
                    _chartSeries = [];
                }
            },
            notFound =>
            {
                Logger.LogWarning("Partner {PartnerId} not found when loading analytics", _partner.Id);
            },
            error =>
            {
                Logger.LogError("Failed to load analytics for partner {PartnerId}: {Error}", _partner.Id, error.Value);
                Snackbar.Add("Kunne ikke hente analytics data", Severity.Error);
            }
        );
    }

    private async Task SelectTimePeriod(int days)
    {
        var previousDays = _selectedDays;

        try
        {
            _selectedDays = days;
            await LoadAnalyticsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load analytics for time period {Days} days", days);
            Snackbar.Add("Kunne ikke hente analytics data. Prøv igen senere.", Severity.Error);
            _selectedDays = previousDays;
        }
    }

    private bool HasPendingTextChanges()
    {
        return !string.IsNullOrEmpty(_partner?.PendingName) ||
               !string.IsNullOrEmpty(_partner?.PendingDescription) ||
               !string.IsNullOrEmpty(_partner?.PendingPartnerPageLink) ||
               !string.IsNullOrEmpty(_partner?.PendingAdLink) ||
               !string.IsNullOrEmpty(_partner?.PendingAdLabelColor);
    }

    private bool HasPendingPartnerCardChanges()
    {
        return HasPendingTextChanges() || !string.IsNullOrEmpty(_partner?.PendingLogoUrl);
    }

    private string GetPendingChangesText()
    {
        if (_partner is null) return string.Empty;

        var changes = new List<string>();
        if (!string.IsNullOrEmpty(_partner.PendingName))
            changes.Add($"Navn: {_partner.Name} → {_partner.PendingName}");
        if (!string.IsNullOrEmpty(_partner.PendingDescription))
            changes.Add($"Beskrivelse opdateret");
        if (!string.IsNullOrEmpty(_partner.PendingPartnerPageLink))
            changes.Add($"Partnerside Link: {_partner.PartnerPageLink} → {_partner.PendingPartnerPageLink}");
        if (!string.IsNullOrEmpty(_partner.PendingAdLink))
            changes.Add($"Annonce Link: {_partner.AdLink} → {_partner.PendingAdLink}");
        if (!string.IsNullOrEmpty(_partner.PendingAdLabelColor))
            changes.Add($"Annonce Label Farve: {_partner.AdLabelColor} → {_partner.PendingAdLabelColor}");
        if (!string.IsNullOrEmpty(_partner.PendingLogoUrl))
            changes.Add("Logo opdateret");

        return string.Join("\n", changes);
    }

    private Partner GetCurrentPartner()
    {
        if (_partner is null)
            return new Partner { Id = Guid.Empty, Name = "", Description = "", PartnerPageLink = "#", UserId = "", CreatedUtc = DateTime.UtcNow, CanHavePartnerCard = true, CanHaveAd = true };

        return new Partner
        {
            Id = _partner.Id,
            Name = _partner.Name,
            Description = _partner.Description,
            LogoUrl = _partner.LogoUrl,
            PartnerPageLink = _partner.PartnerPageLink,
            UserId = _partner.UserId,
            CreatedUtc = _partner.CreatedUtc,
            CanHavePartnerCard = _partner.CanHavePartnerCard,
            CanHaveAd = _partner.CanHaveAd
        };
    }

    private Partner GetPendingPartner()
    {
        if (_partner is null)
            return new Partner { Id = Guid.Empty, Name = "", Description = "", PartnerPageLink = "#", UserId = "", CreatedUtc = DateTime.UtcNow, CanHavePartnerCard = true, CanHaveAd = true };

        return new Partner
        {
            Id = _partner.Id,
            Name = !string.IsNullOrEmpty(_partner.PendingName) ? _partner.PendingName : _partner.Name,
            Description = !string.IsNullOrEmpty(_partner.PendingDescription) ? _partner.PendingDescription : _partner.Description,
            LogoUrl = !string.IsNullOrEmpty(_partner.PendingLogoUrl) ? _partner.PendingLogoUrl : _partner.LogoUrl,
            PartnerPageLink = !string.IsNullOrEmpty(_partner.PendingPartnerPageLink) ? _partner.PendingPartnerPageLink : _partner.PartnerPageLink,
            UserId = _partner.UserId,
            CreatedUtc = _partner.CreatedUtc,
            CanHavePartnerCard = _partner.CanHavePartnerCard,
            CanHaveAd = _partner.CanHaveAd
        };
    }

    private async Task ApproveChangesAsync()
    {
        if (_partner is null)
        {
            return;
        }

        _processing = true;
        try
        {
            var result = await PartnerService.ApproveChangesAsync(_partner.Id);

            result.Switch(
                success =>
                {
                    Snackbar.Add("Ændringer godkendt!", Severity.Success);
                },
                error => Snackbar.Add(error.Value, Severity.Error)
            );

            await LoadPartnerDataAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to approve changes for partner {PartnerId}", _partner.Id);
            Snackbar.Add("Kunne ikke godkende ændringer. Prøv igen senere.", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task RejectChangesAsync()
    {
        if (_partner is null)
        {
            return;
        }

        _processing = true;
        try
        {
            var result = await PartnerService.RejectChangesAsync(_partner.Id);

            result.Switch(
                success =>
                {
                    Snackbar.Add("Ændringer afvist!", Severity.Success);
                },
                error => Snackbar.Add(error.Value, Severity.Error)
            );

            await LoadPartnerDataAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to reject changes for partner {PartnerId}", _partner.Id);
            Snackbar.Add("Kunne ikke afvise ændringer. Prøv igen senere.", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/backoffice/partners");
    }
}
