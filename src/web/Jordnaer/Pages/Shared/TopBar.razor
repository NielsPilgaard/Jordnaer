@using Jordnaer.Features.Authentication

@inject NavigationManager Navigation
@inject UnreadMessageSignalRClient UnreadMessageSignalRClient
@inject IChatService ChatService
@inject GroupService GroupService
@inject GroupMembershipSignalRClient GroupMembershipSignalRClient
@inject CurrentUser CurrentUser
@inject IJSRuntime JsRuntime

@implements IAsyncDisposable

<MudAppBar Fixed="false" Elevation="0" Dense="false"
	Style="@($"background: {JordnaerTheme.CustomTheme.PaletteLight.BackgroundGray}")">

	@* Desktop Navigation - Icons with Labels *@
	<div class="topbar-desktop" style="display: flex; gap: 4px;">
		<MudButton Href="/" StartIcon="@Icons.Material.Filled.Home" Variant="Variant.Text"
			Class="@GetNavLinkClass("/", useExactMatch: true)" Style="@JordnaerPalette.BlueBody.ToTextColor()">
			Hjem
		</MudButton>
		<MudButton Href="/users" StartIcon="@Icons.Material.Filled.PersonSearch" Variant="Variant.Text"
			Class="@GetNavLinkClass("/users")" Style="@JordnaerPalette.BlueBody.ToTextColor()">
			Søg
		</MudButton>

		<AuthorizeView>
			<Authorized>
				<MudBadge Content="@_pendingGroupRequestCount" Visible="@(_pendingGroupRequestCount > 0)" Color="Color.Warning" Overlap="true"
					Class="mx-0" BadgeClass="badge-offset">
					<MudButton Href="/groups" StartIcon="@Icons.Material.Filled.Groups" Variant="Variant.Text"
						Class="@GetNavLinkClass("/groups")" Style="@JordnaerPalette.BlueBody.ToTextColor()">
						Grupper
					</MudButton>
				</MudBadge>
			</Authorized>
			<NotAuthorized>
				<MudButton Href="/groups" StartIcon="@Icons.Material.Filled.Groups" Variant="Variant.Text"
					Class="@GetNavLinkClass("/groups")" Style="@JordnaerPalette.BlueBody.ToTextColor()">
					Grupper
				</MudButton>
			</NotAuthorized>
		</AuthorizeView>

		<Feature Name="@FeatureFlags.Posts">
			<MudButton Href="/posts" StartIcon="@Icons.Material.Filled.Feed" Variant="Variant.Text"
				Class="@GetNavLinkClass("/posts")" Style="@JordnaerPalette.BlueBody.ToTextColor()">
				Opslag
			</MudButton>
		</Feature>

		<AuthorizeView>
			<Authorized>
				<MudBadge Content="@_unreadCount" Visible="@(_unreadCount > 0)" Color="Color.Info" Overlap="true"
					Class="mx-0" BadgeClass="badge-offset">
					<MudButton Href="/chat" StartIcon="@Icons.Material.Filled.Chat" Variant="Variant.Text"
						Class="@GetNavLinkClass("/chat")" Style="@JordnaerPalette.BlueBody.ToTextColor()">
						Chat
					</MudButton>
				</MudBadge>
			</Authorized>
		</AuthorizeView>
	</div>

	@* Mobile Navigation - Dropdown Menu *@
	<div class="topbar-mobile-menu">
		<input type="checkbox" id="mobile-menu-toggle" class="mobile-menu-toggle" />
		<label for="mobile-menu-toggle" class="backdrop"></label>
		<label for="mobile-menu-toggle" class="mobile-menu-button" aria-label="Toggle navigation menu">
			<MudIcon Icon="@Icons.Material.Filled.Menu" Style="@JordnaerPalette.BlueBody.ToTextColor()" />
		</label>

		<nav class="mobile-menu-dropdown" aria-label="Mobile navigation"
			onclick="document.getElementById('mobile-menu-toggle').checked = false;">
			<a href="/" class="@GetMobileNavLinkClass("/", true)" style="@JordnaerPalette.BlueBody.ToTextColor()">
				<MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Small" Style="margin-right: 0.75rem;" />
				Hjem
			</a>
			<a href="/users" class="@GetMobileNavLinkClass("/users")" style="@JordnaerPalette.BlueBody.ToTextColor()">
				<MudIcon Icon="@Icons.Material.Filled.PersonSearch" Size="Size.Small" Style="margin-right: 0.75rem;" />
				Søg
			</a>
			<a href="/groups" class="@GetMobileNavLinkClass("/groups")" style="@JordnaerPalette.BlueBody.ToTextColor()">
				<MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Small" Style="margin-right: 0.75rem;" />
				Grupper
				<AuthorizeView>
					<Authorized>
						@if (_pendingGroupRequestCount > 0)
						{
							<MudBadge Content="@_pendingGroupRequestCount" Color="Color.Warning" Style="margin-left: 8px;" />
						}
					</Authorized>
				</AuthorizeView>
			</a>

			<Feature Name="@FeatureFlags.Posts">
				<a href="/posts" class="@GetMobileNavLinkClass("/posts")" style="@JordnaerPalette.BlueBody.ToTextColor()">
					<MudIcon Icon="@Icons.Material.Filled.Feed" Size="Size.Small" Style="margin-right: 0.75rem;" />
					Opslag
				</a>
			</Feature>

			<AuthorizeView>
				<Authorized>
					<a href="/chat" class="@GetMobileNavLinkClass("/chat")" style="@JordnaerPalette.BlueBody.ToTextColor()">
						<MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Small" Style="margin-right: 0.75rem;" />
						Chat
						@if (_unreadCount > 0)
						{
							<MudBadge Content="@_unreadCount" Color="Color.Info" Style="margin-left: 8px;" />
						}
					</a>
				</Authorized>
			</AuthorizeView>
		</nav>
	</div>

	<MudSpacer />

	<AuthorizeView>
		<Authorized>
			@* Desktop Backoffice Dropdown (Admin Only) *@
			<AuthorizeView Policy="@AuthorizationPolicies.AdminOnly" Context="desktopBackofficeContext">
				<Authorized>
					<div class="topbar-desktop profile-dropdown">
						<input type="checkbox" id="backoffice-menu-toggle" class="profile-menu-toggle" />
						<label for="backoffice-menu-toggle" class="backdrop"></label>
						<label for="backoffice-menu-toggle" class="profile-menu-button"
							style="@JordnaerPalette.BlueBody.ToTextColor()">
							<MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Style="margin-right: 0.25rem;" />
							<span class="font-open-sans-medium">Backoffice</span>
							<MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Style="margin-left: 0.25rem;" />
						</label>
						<nav class="profile-menu-dropdown" aria-label="Backoffice menu"
							onclick="document.getElementById('backoffice-menu-toggle').checked = false;">
							<a href="/backoffice/users" class="@GetProfileMenuItemClass("/backoffice/users")" style="@JordnaerPalette.BlueBody.ToTextColor()">
								<MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small"
									Style="margin-right: 0.75rem;" />
								Brugere
							</a>
							<a href="/backoffice/partners" class="@GetProfileMenuItemClass("/backoffice/partners")" style="@JordnaerPalette.BlueBody.ToTextColor()">
								<MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small"
									Style="margin-right: 0.75rem;" />
								Partnere
							</a>
							<a href="/backoffice/emails" class="@GetProfileMenuItemClass("/backoffice/emails")" style="@JordnaerPalette.BlueBody.ToTextColor()">
								<MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small"
									Style="margin-right: 0.75rem;" />
								Emails
							</a>
						</nav>
					</div>
				</Authorized>
			</AuthorizeView>

			@* Desktop Profile Dropdown *@
			<div class="topbar-desktop profile-dropdown">
				<input type="checkbox" id="profile-menu-toggle" class="profile-menu-toggle" />
				<label for="profile-menu-toggle" class="backdrop"></label>
				<label for="profile-menu-toggle" class="profile-menu-button"
					style="@JordnaerPalette.BlueBody.ToTextColor()">
					<MudIcon Icon="@Icons.Material.Filled.Person" Style="margin-right: 0.25rem;" />
					<span class="font-open-sans-medium">Profil</span>
					<MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Style="margin-left: 0.25rem;" />
				</label>
				<nav class="profile-menu-dropdown" aria-label="Profile menu"
					onclick="document.getElementById('profile-menu-toggle').checked = false;">
					<a href="/profile" class="@GetProfileMenuItemClass("/profile")" style="@JordnaerPalette.BlueBody.ToTextColor()">
						<MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small"
							Style="margin-right: 0.75rem;" />
						Profil
					</a>
					<AuthorizeView Policy="@AuthorizationPolicies.PartnerAccess" Context="desktopPartnerContext">
						<Authorized>
							<a href="/partner/dashboard" class="@GetProfileMenuItemClass("/partner/dashboard")" style="@JordnaerPalette.BlueBody.ToTextColor()">
								<MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small"
									Style="margin-right: 0.75rem;" />
								Partner Dashboard
							</a>
						</Authorized>
					</AuthorizeView>
					<a href="/settings/notifications" class="@GetProfileMenuItemClass("/settings/notifications")" style="@JordnaerPalette.BlueBody.ToTextColor()">
						<MudIcon Icon="@Icons.Material.Filled.Notifications" Size="Size.Small"
							Style="margin-right: 0.75rem;" />
						Notifikationer
					</a>
					<a href="/Account/Manage" class="@GetProfileMenuItemClass("/Account/Manage")" style="@JordnaerPalette.BlueBody.ToTextColor()">
						<MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small"
							Style="margin-right: 0.75rem;" />
						Kontoindstillinger
					</a>
					<a href="/Account/Logout" class="profile-menu-item" style="@JordnaerPalette.BlueBody.ToTextColor()">
						<MudIcon Icon="@Icons.Material.Filled.Logout" Size="Size.Small"
							Style="margin-right: 0.75rem;" />
						Log ud
					</a>
				</nav>
			</div>

			@* Mobile Backoffice Dropdown (Admin Only) *@
			<AuthorizeView Policy="@AuthorizationPolicies.AdminOnly" Context="mobileBackofficeContext">
				<Authorized>
					<div class="topbar-mobile profile-dropdown">
						<input type="checkbox" id="backoffice-menu-toggle-mobile" class="profile-menu-toggle" />
						<label for="backoffice-menu-toggle-mobile" class="backdrop"></label>
						<label for="backoffice-menu-toggle-mobile" class="profile-menu-button"
							style="@JordnaerPalette.BlueBody.ToTextColor()">
							<MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Size="Size.Medium" />
							<MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Size="Size.Small" Style="margin-left: -0.25rem;" />
						</label>
						<nav class="profile-menu-dropdown" aria-label="Backoffice menu"
							onclick="document.getElementById('backoffice-menu-toggle-mobile').checked = false;">
							<a href="/backoffice/users" class="@GetProfileMenuItemClass("/backoffice/users")" style="@JordnaerPalette.BlueBody.ToTextColor()">
								<MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small"
									Style="margin-right: 0.75rem;" />
								Brugere
							</a>
							<a href="/backoffice/partners" class="@GetProfileMenuItemClass("/backoffice/partners")" style="@JordnaerPalette.BlueBody.ToTextColor()">
								<MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small"
									Style="margin-right: 0.75rem;" />
								Partnere
							</a>
							<a href="/backoffice/emails" class="@GetProfileMenuItemClass("/backoffice/emails")" style="@JordnaerPalette.BlueBody.ToTextColor()">
								<MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small"
									Style="margin-right: 0.75rem;" />
								Emails
							</a>
						</nav>
					</div>
				</Authorized>
			</AuthorizeView>

			@* Mobile Profile Dropdown *@
			<div class="topbar-mobile profile-dropdown">
				<input type="checkbox" id="profile-menu-toggle-mobile" class="profile-menu-toggle" />
				<label for="profile-menu-toggle-mobile" class="backdrop"></label>
				<label for="profile-menu-toggle-mobile" class="profile-menu-button"
					style="@JordnaerPalette.BlueBody.ToTextColor()">
					<MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Medium" />
					<MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" Size="Size.Small" Style="margin-left: -0.25rem;" />
				</label>
				<nav class="profile-menu-dropdown" aria-label="Profile menu"
					onclick="document.getElementById('profile-menu-toggle-mobile').checked = false;">
					<a href="/profile" class="@GetProfileMenuItemClass("/profile")" style="@JordnaerPalette.BlueBody.ToTextColor()">
						<MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small"
							Style="margin-right: 0.75rem;" />
						Profil
					</a>
					<AuthorizeView Policy="@AuthorizationPolicies.PartnerAccess" Context="mobilePartnerContext">
						<Authorized>
							<a href="/partner/dashboard" class="@GetProfileMenuItemClass("/partner/dashboard")" style="@JordnaerPalette.BlueBody.ToTextColor()">
								<MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small"
									Style="margin-right: 0.75rem;" />
								Partner Dashboard
							</a>
						</Authorized>
					</AuthorizeView>
					<a href="/settings/notifications" class="@GetProfileMenuItemClass("/settings/notifications")" style="@JordnaerPalette.BlueBody.ToTextColor()">
						<MudIcon Icon="@Icons.Material.Filled.Notifications" Size="Size.Small"
							Style="margin-right: 0.75rem;" />
						Notifikationer
					</a>
					<a href="/Account/Manage" class="@GetProfileMenuItemClass("/Account/Manage")" style="@JordnaerPalette.BlueBody.ToTextColor()">
						<MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small"
							Style="margin-right: 0.75rem;" />
						Kontoindstillinger
					</a>
					<a href="/Account/Logout" class="profile-menu-item" style="@JordnaerPalette.BlueBody.ToTextColor()">
						<MudIcon Icon="@Icons.Material.Filled.Logout" Size="Size.Small"
							Style="margin-right: 0.75rem;" />
						Log ud
					</a>
				</nav>
			</div>
		</Authorized>
		<NotAuthorized>
			<div class="topbar-desktop">
				<MudButton Href="/Account/Register" StartIcon="@Icons.Material.Filled.Login" Variant="Variant.Outlined"
					Class="font-open-sans-semibold"
					Style="@($"{JordnaerPalette.BlueBody.ToTextColor()}; border-color: {JordnaerPalette.BlueBody}")">
					Opret konto
				</MudButton>
			</div>
			<div class="topbar-mobile">
				<MudIconButton Href="/Account/Register" Icon="@Icons.Material.Filled.Login" Variant="Variant.Outlined"
					Style="@($"{JordnaerPalette.BlueBody.ToTextColor()}; border-color: {JordnaerPalette.BlueBody}")"
					Size="Size.Medium" title="Opret konto" aria-label="Opret konto" />
			</div>
		</NotAuthorized>
	</AuthorizeView>
</MudAppBar>

@code {
	private int _unreadCount = 0;
	private int _pendingGroupRequestCount = 0;
	private bool _isJsAvailable = false;
	private string? _baseTitle = null;
	private string _currentPath = string.Empty;

	protected override async Task OnInitializedAsync()
	{
		// Get current path for active nav highlighting
		_currentPath = new Uri(Navigation.Uri).AbsolutePath;

		// Subscribe to navigation changes to update active nav item
		Navigation.LocationChanged += OnLocationChanged;

		if (CurrentUser.Id is null)
		{
			return;
		}

		// Get initial unread count
		_unreadCount = await ChatService.GetUnreadMessageCountAsync(CurrentUser.Id);

		// Get pending group membership requests count
		var pendingCounts = await GroupService.GetPendingMembershipCountsForUserAsync();
		_pendingGroupRequestCount = pendingCounts.Values.Sum();

		// Subscribe to real-time updates
		UnreadMessageSignalRClient.OnMessageReceived(async message =>
		{
			// Only increment if the message is not from the current user
			if (message.SenderId != CurrentUser.Id)
			{
				_unreadCount++;
				await UpdatePageTitle();
				await InvokeAsync(StateHasChanged);
			}
		});

		UnreadMessageSignalRClient.OnChatStarted(async chat =>
		{
			// Only increment if the chat was started by someone else
			if (chat.InitiatorId != CurrentUser.Id)
			{
				// Count the number of initial messages in the new chat
				_unreadCount += chat.Messages.Count;
				await UpdatePageTitle();
				await InvokeAsync(StateHasChanged);
			}
		});

		// Subscribe to local messages marked as read event
		ChatService.MessagesMarkedAsRead += OnMessagesMarkedAsRead;

		// Subscribe to group membership status changes
		GroupMembershipSignalRClient.OnMembershipStatusChanged(async notification =>
		{
			_pendingGroupRequestCount += notification.PendingCountChange;
			if (_pendingGroupRequestCount < 0)
			{
				_pendingGroupRequestCount = 0;
			}
			await InvokeAsync(StateHasChanged);
		});

		await UnreadMessageSignalRClient.StartAsync();
		await GroupMembershipSignalRClient.StartAsync();
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			_isJsAvailable = true;

			// Get the current page title from the document
			_baseTitle = await JsRuntime.InvokeAsync<string>("eval", "document.title");

			// Update page title with unread count if needed
			await UpdatePageTitle();
		}
	}

	private async void OnMessagesMarkedAsRead(object? sender, MessagesMarkedAsReadEventArgs e)
	{
		_unreadCount -= e.MessageCount;
		if (_unreadCount < 0)
		{
			_unreadCount = 0;
		}
		await UpdatePageTitle();
		await InvokeAsync(StateHasChanged);
	}

	private async Task UpdatePageTitle()
	{
		if (!_isJsAvailable || _baseTitle is null)
		{
			return;
		}

		// Remove any existing unread count prefix from the base title
		var cleanTitle = _baseTitle;
		if (cleanTitle.StartsWith('(') && cleanTitle.Contains(") "))
		{
			var closingParenIndex = cleanTitle.IndexOf(") ");
			cleanTitle = cleanTitle.Substring(closingParenIndex + 2);
		}

		var title = _unreadCount > 0
		? $"({_unreadCount}) {cleanTitle}"
		: cleanTitle;

		await JsRuntime.InvokeVoidAsync("eval", $"document.title = '{title}'");
	}

	private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
	{
		_currentPath = new Uri(e.Location).AbsolutePath;
		StateHasChanged();
	}

	private bool IsActive(string path, bool useExactMatch = false)
	{
		if (useExactMatch)
		{
			return string.Equals(_currentPath, path, StringComparison.OrdinalIgnoreCase);
		}

		// For non-exact matches, check if the current path starts with the given path
		return _currentPath.StartsWith(path, StringComparison.OrdinalIgnoreCase);
	}

	private string GetNavLinkClass(string path, bool useExactMatch = false)
	{
		var baseClass = "topbar-nav-link font-open-sans-semibold";
		return IsActive(path, useExactMatch) ? $"{baseClass} active" : baseClass;
	}

	private string GetMobileNavLinkClass(string path, bool useExactMatch = false)
	{
		var baseClass = "mobile-menu-item";
		return IsActive(path, useExactMatch) ? $"{baseClass} active" : baseClass;
	}

	private string GetProfileMenuItemClass(string path, bool useExactMatch = false)
	{
		var baseClass = "profile-menu-item";
		return IsActive(path, useExactMatch) ? $"{baseClass} active" : baseClass;
	}

	public async ValueTask DisposeAsync()
	{
		Navigation.LocationChanged -= OnLocationChanged;
		ChatService.MessagesMarkedAsRead -= OnMessagesMarkedAsRead;
		await UnreadMessageSignalRClient.StopAsync();
		await GroupMembershipSignalRClient.StopAsync();
	}
}

<style>
	.badge-offset {
		margin-left: -6px;
		margin-top: -6px;
	}
</style>