@page "/posts"

@using Jordnaer.Features.Posts
@using Jordnaer.Features.Ad
@inject PostSearchService PostSearchService
@inject IAdProvider AdProvider
@inject CurrentUser CurrentUser
@inject ISnackbar Snackbar
@inject ILogger<PostPage> Logger
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

@attribute [Sitemap]

<MetadataComponent Title="Opslag" Description="Læs og skriv opslag om stort og småt her" />

<MudLoading @bind-Loading="_isLoading" Darken Overlap>

    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudText Typo="Typo.h3" Class="mb-6 text-center font-cherry-bomb-one"
            Style="@($"color: {JordnaerPalette.RedHeader};")">
            Opslag
        </MudText>
        <CreatePostComponent OnPostCreated="@OnPostCreated" />

        <MudDivider Class="my-4" />

        @* Recent Posts Feed *@
        @{
            var items = GetItemsWithAds();
            var noPosts = items.Count is 0;
        }
        @if (noPosts is false)
        {
            @foreach (var item in items)
            {
                @if (item.IsAd && item.Ad is not null)
                {
                    <AdCard Link="@item.Ad.Link" ImagePath="@item.Ad.ImagePath" ImageAlt="@item.Ad.Title"
                            PartnerId="@(item.Ad.PartnerId ?? Guid.Empty)" LabelColor="@item.Ad.LabelColor" />
                }
                else if (item.Post is not null)
                {
                    <PostCardComponent PostItem="item.Post" CurrentUserId="@(_currentUserId ?? string.Empty)"
                        OnPostDeleted="@OnRecentPostDeleted" OnPostUpdated="@OnPostUpdated" />
                }
            }

            @* Load More button *@
            @if (_recentPosts.HasMore)
            {
                <div class="d-flex justify-center my-4">
                    <MudButton Variant="Variant.Outlined" OnClick="LoadMorePosts" Disabled="@_isLoadingMore">
                        @if (_isLoadingMore)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate />
                            <MudText Class="ml-2">Indlæser...</MudText>
                        }
                        else
                        {
                            <MudText>Vis flere opslag</MudText>
                        }
                    </MudButton>
                </div>
            }
        }
        else
        {
            <MudAlert Severity="Severity.Info">
                Ingen opslag endnu. Vær den første til at dele noget!
            </MudAlert>
        }

        @* Subtle link to search *@
        @if (noPosts is false)
        {
            <MudDivider Class="my-6" />
            <div class="text-center mb-4">
                <MudButton Href="/posts/search" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Search"
                    Size="Size.Small" Color="Color.Default">
                    Find opslag
                </MudButton>
            </div>
        }
    </MudContainer>

</MudLoading>

@code {
    private PostSearchResult _recentPosts = new();
    private List<AdData> _ads = [];

    private bool _isLoading = false;
    private bool _isLoadingMore = false;
    private string? _currentUserId;

    private record FeedItem
    {
        public bool IsAd { get; init; }
        public PostDto? Post { get; init; }
        public AdData? Ad { get; init; }
    }

    protected override async Task OnInitializedAsync()
    {
        _currentUserId = CurrentUser?.Id;

        // Load ads (non-critical, don't let failures block the page)
        var adsResult = await AdProvider.GetAdsAsync(1);
        _ads = adsResult.Match(
            ads => ads,
            error =>
            {
                Logger.LogWarning("Failed to load ads for posts page: {Error}", error.Value);
                return new List<AdData>();
            }
        );

        await LoadRecentPosts();
    }

    private async Task LoadRecentPosts()
    {
        _isLoading = true;
        try
        {
            var result = await PostSearchService.GetRecentPostsAsync(pageSize: 10);

            result.Switch(
            success => _recentPosts = success,
            error => Snackbar.Add(error.Value, Severity.Error)
            );
        }
        catch (Exception exception)
        {
            Logger.LogError(exception, "Error occurred loading recent posts");
            Snackbar.Add("Der opstod en fejl ved indlæsning af opslag.", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadMorePosts()
    {
        _isLoadingMore = true;
        try
        {
            var result = await PostSearchService.GetRecentPostsAsync(
            pageSize: 10,
            cursor: _recentPosts.NextCursor);

            result.Switch(
            success =>
            {
                _recentPosts.Posts.AddRange(success.Posts);
                _recentPosts.NextCursor = success.NextCursor;
                // HasMore is computed from NextCursor
            },
            error => Snackbar.Add(error.Value, Severity.Error)
            );
        }
        catch (Exception exception)
        {
            Logger.LogError(exception, "Error occurred loading more posts");
            Snackbar.Add("Der opstod en fejl ved indlæsning af flere opslag.", Severity.Error);
        }
        finally
        {
            _isLoadingMore = false;
        }
    }

    private void OnRecentPostDeleted(Guid deletedPostId)
    {
        // Remove the deleted post from the in-memory list to preserve pagination
        var postToRemove = _recentPosts.Posts.FirstOrDefault(p => p.Id == deletedPostId);
        if (postToRemove is not null)
        {
            _recentPosts.Posts.Remove(postToRemove);
            StateHasChanged();
        }
    }

    private async Task OnPostUpdated()
    {
        await LoadRecentPosts();
    }

    private async Task OnPostCreated()
    {
        await LoadRecentPosts();
    }

    private List<FeedItem> GetItemsWithAds()
    {
        var items = new List<FeedItem>();

        if (_recentPosts.Posts.Count == 0)
        {
            return items;
        }

        if (_ads.Count == 0)
        {
            // No ads available, just return posts
            items.AddRange(_recentPosts.Posts.Select(p => new FeedItem { Post = p }));
            return items;
        }

        // Insert an ad every 10 posts at position 3 within each batch
        // (e.g., positions 3, 13, 23, etc.)
        var adInterval = 10;
        var adPositionInBatch = 3;

        for (int i = 0; i < _recentPosts.Posts.Count; i++)
        {
            // Check if we should insert an ad before this post
            if (i > 0 && i % adInterval == adPositionInBatch)
            {
                items.Add(new FeedItem { IsAd = true, Ad = _ads[0] });
            }

            items.Add(new FeedItem { Post = _recentPosts.Posts[i] });
        }

        return items;
    }
}