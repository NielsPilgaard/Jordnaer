@page "/posts"

@inject PostSearchService PostSearchService
@inject ISnackbar Snackbar
@inject ILogger<Posts> Logger
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

@attribute [Sitemap]

<MetadataComponent Title="Opslag"
                   Description="Læs og skriv opslag om stort og småt her" />

<MudLoading @bind-Loading="_isSearching" Darken Overlap>

    <CreatePostComponent />

    <MudDivider Class="my-4" />

    <PostSearchForm OnValidSubmit="@Search" @bind-Filter="_filter" />

    @if (!_hasSearched)
    {
        return;
    }

    @if (_searchResult.TotalCount == 0)
    {
        <MudPaper Elevation="3" Class="pa-10 mt-5">
            <MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center" Class="align-center">
                <MudText Align="Align.Center" Typo="Typo.h6">Ingen opslag fundet.</MudText>
            </MudAlert>
        </MudPaper>
        return;
    }

    <AdCard ImageAlt="Reklame for Moon Creative"
            ImagePath="images/ads/mooncreative_mobile.png"
            Link="https://www.mooncreative.dk/" />

    <PostSearchResultComponent Filter="_filter" SearchResult="_searchResult" SelectedPageChanged="@OnSelectedPageChanged" />

</MudLoading>

@code {
    [SupplyParameterFromQuery]
    public string? Contents { get; set; }
    [SupplyParameterFromQuery]
    public string[]? Categories { get; set; } = [];
    [SupplyParameterFromQuery]
    public int? WithinRadiusKilometers { get; set; }
    [SupplyParameterFromQuery]
    public string? Location { get; set; }
    [SupplyParameterFromQuery]
    public double? Latitude { get; set; }
    [SupplyParameterFromQuery]
    public double? Longitude { get; set; }
    [SupplyParameterFromQuery]
    public int? PageNumber { get; set; }
    [SupplyParameterFromQuery]
    public int? PageSize { get; set; }

    private PostSearchFilter _filter = new();
    private PostSearchResult _searchResult = new();

    private bool _isSearching = false;
    private bool _hasSearched = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadFromQueryString();
    }

    private async Task Search()
    {
        _isSearching = true;
        try
        {
            var result = await PostSearchService.GetPostsAsync(_filter);

            await UpdateQueryString();

            Snackbar.Clear();

            result.Switch(
                success =>
                {
                    _searchResult = success;
                    Snackbar.Add($"{_searchResult.TotalCount} opslag fundet.", Severity.Success);
                },
                error => Snackbar.Add(error.Value, Severity.Error)
            );
        }
        catch (Exception exception)
        {
            Logger.LogError(exception, "Error occurred during post search");
            Snackbar.Clear();
            Snackbar.Add("Der opstod en fejl under søgningen.", Severity.Error);
        }
        finally
        {
            _hasSearched = true;
            _isSearching = false;
        }
    }

    private static readonly Dictionary<string, object?> _queryStrings = [];
    private async Task UpdateQueryString()
    {
        _queryStrings[nameof(_filter.Contents).ToLower()] = _filter.Contents;
        _queryStrings[nameof(_filter.Categories).ToLower()] = _filter.Categories;
        _queryStrings[nameof(_filter.WithinRadiusKilometers).ToLower()] = _filter.WithinRadiusKilometers;
        _queryStrings[nameof(_filter.Location).ToLower()] = _filter.Location;
        _queryStrings[nameof(_filter.Latitude).ToLower()] = _filter.Latitude;
        _queryStrings[nameof(_filter.Longitude).ToLower()] = _filter.Longitude;
        _queryStrings[nameof(_filter.PageSize).ToLower()] = _filter.PageSize;
        _queryStrings[nameof(_filter.PageNumber).ToLower()] = _filter.PageNumber;

        var newUrl = Navigation.GetUriWithQueryParameters(_queryStrings);

        await JsRuntime.NavigateTo(newUrl);
    }

    private async ValueTask LoadFromQueryString()
    {
        var queryStrings = new Uri(Navigation.Uri).Query;
        if (string.IsNullOrEmpty(queryStrings))
        {
            return;
        }

        var filter = new PostSearchFilter
        {
            Contents = Contents,
            Categories = Categories,
            WithinRadiusKilometers = WithinRadiusKilometers,
            Location = Location,
            Latitude = Latitude,
            Longitude = Longitude,
        };

        if (PageNumber is not null)
        {
            filter.PageNumber = PageNumber.Value;
        }

        if (PageSize is not null)
        {
            filter.PageSize = PageSize.Value;
        }

        _filter = filter;

        await Search();
    }

    private async Task OnSelectedPageChanged(int selectedPage)
    {
        _filter.PageNumber = selectedPage;
        await Search();
    }
}
