@page "/posts"

@using Jordnaer.Features.Posts
@inject PostSearchService PostSearchService
@inject CurrentUser CurrentUser
@inject ISnackbar Snackbar
@inject ILogger<Posts> Logger
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

@attribute [Sitemap]

<MetadataComponent Title="Opslag" Description="Læs og skriv opslag om stort og småt her" />

<MudLoading @bind-Loading="_isLoading" Darken Overlap>

    <MudContainer MaxWidth="MaxWidth.Medium">
        <CreatePostComponent OnPostCreated="@OnPostCreated" />

        <MudDivider Class="my-4" />

        @* Recent Posts Feed *@
        @if (_recentPosts.Posts.Any())
        {
            @foreach (var (post, index) in _recentPosts.Posts.Select((p, i) => (p, i)))
            {
                <PostCardComponent PostItem="post" CurrentUserId="@(_currentUserId ?? string.Empty)"
                    OnPostDeleted="@OnRecentPostDeleted" OnPostUpdated="@OnPostUpdated" />

                @* Show ad after 3rd post *@
                @if (index == 2)
                {
                    <SponsorAd Class="my-5" ImageAlt="Sponsor reklame" MobileImagePath="images/ads/mooncreative_mobile.png"
                        DesktopImagePath="images/ads/mooncreative_mobile.png" Link="https://www.mooncreative.dk/" />
                }
            }

            @* Load More button *@
            @if (_recentPosts.HasMore)
            {
                <div class="d-flex justify-center my-4">
                    <MudButton Variant="Variant.Outlined" OnClick="LoadMorePosts" Disabled="@_isLoadingMore">
                        @if (_isLoadingMore)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate />
                            <MudText Class="ml-2">Indlæser...</MudText>
                        }
                        else
                        {
                            <MudText>Vis flere opslag</MudText>
                        }
                    </MudButton>
                </div>
            }
        }
        else
        {
            <MudPaper Elevation="0" Class="pa-6 text-center">
                <MudText Typo="Typo.body1" Color="Color.Default">
                    Ingen opslag endnu. Vær den første til at dele noget!
                </MudText>
            </MudPaper>
        }

        @* Subtle link to search *@
        <MudDivider Class="my-6" />
        <div class="text-center mb-4">
            <MudButton Href="/posts/search" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Search"
                Size="Size.Small" Color="Color.Default">
                Søg i opslag
            </MudButton>
        </div>
    </MudContainer>

</MudLoading>

@code {
    private PostSearchResult _recentPosts = new();

    private bool _isLoading = false;
    private bool _isLoadingMore = false;
    private string? _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        _currentUserId = CurrentUser?.Id;

        // Load recent posts by default
        await LoadRecentPosts();
    }

    private async Task LoadRecentPosts()
    {
        _isLoading = true;
        try
        {
            var result = await PostSearchService.GetRecentPostsAsync(pageSize: 10);

            result.Switch(
                success => _recentPosts = success,
                error => Snackbar.Add(error.Value, Severity.Error)
            );
        }
        catch (Exception exception)
        {
            Logger.LogError(exception, "Error occurred loading recent posts");
            Snackbar.Add("Der opstod en fejl ved indlæsning af opslag.", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadMorePosts()
    {
        _isLoadingMore = true;
        try
        {
            var result = await PostSearchService.GetRecentPostsAsync(
                pageSize: 10,
                cursor: _recentPosts.NextCursor);

            result.Switch(
                success =>
                {
                    _recentPosts.Posts.AddRange(success.Posts);
                    _recentPosts.NextCursor = success.NextCursor;
                    // HasMore is computed from NextCursor
                },
                error => Snackbar.Add(error.Value, Severity.Error)
            );
        }
        catch (Exception exception)
        {
            Logger.LogError(exception, "Error occurred loading more posts");
            Snackbar.Add("Der opstod en fejl ved indlæsning af flere opslag.", Severity.Error);
        }
        finally
        {
            _isLoadingMore = false;
        }
    }

    private async Task OnRecentPostDeleted(Guid deletedPostId)
    {
        // Remove the deleted post from the in-memory list to preserve pagination
        var postToRemove = _recentPosts.Posts.FirstOrDefault(p => p.Id == deletedPostId);
        if (postToRemove is not null)
        {
            _recentPosts.Posts.Remove(postToRemove);
            _recentPosts.TotalCount--;
            StateHasChanged();
        }
    }

    private async Task OnPostUpdated()
    {
        await LoadRecentPosts();
    }

    private async Task OnPostCreated()
    {
        await LoadRecentPosts();
    }
}