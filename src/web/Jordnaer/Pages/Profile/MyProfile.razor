@page "/profile"
@using NetTopologySuite.Geometries

@inject ICategoryCache CategoryCache
@inject IProfileCache ProfileCache
@inject IProfileService ProfileService
@inject ILocationService LocationService
@inject ISnackbar Snackbar

@attribute [Authorize]

<MetadataComponent Title="Redigér Profil" Description="Her kan du redigere din profil" />

<MudLoading @bind-Loading="_isLoading" Darken Overlap>
    @if (_userProfile is null)
    {
        return;
    }

    <MudContainer MaxWidth="MaxWidth.Large" Class="my-6">

        @* View Profile Link *@
        <div class="mb-6 d-flex justify-center">
            <MudButton Disabled="@(_userProfile.UserName is null)" Href="@($"/{_userProfile.UserName}")"
                Size="Size.Large" Color="Color.Info" Variant="Variant.Outlined"
                StartIcon="@Icons.Material.Filled.KeyboardArrowLeft" EndIcon="@Icons.Material.Filled.Person"
                Style="@($"{JordnaerPalette.BlueBody.ToTextColor()}; border-color: {JordnaerPalette.BlueBody}")">
                @(_userProfile.UserName is null
                                ? "Sæt et brugernavn for at gøre din profil offentlig"
                                : "Se hvordan andre ser din profil")
            </MudButton>
        </div>

        <EditForm Model="@_userProfile" OnValidSubmit="UpdateUserProfile">
            <DataAnnotationsValidator />

            @* Profile Picture & Basic Info *@
            <MudPaper Elevation="3" Class="pa-6 mb-4">
                <MudText Typo="Typo.h4" Class="mb-6"
                    Style="@($"color: {JordnaerPalette.RedHeader}; font-family: 'Cherry Bomb One', cursive; letter-spacing: 0.11em;")">
                    Grundlæggende Info
                </MudText>

                <div class="d-flex justify-center mb-6">
                    <UserProfilePicture @bind-UserProfile="_userProfile" />
                </div>

                <MudGrid Spacing="3">
                    <MudItem xs="12" sm="4">
                        <MudTextField Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AlternateEmail"
                            @bind-Value="@_userProfile.UserName" For="() => _userProfile.UserName" Label="Brugernavn"
                            Variant="Variant.Outlined" name="username" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="@_userProfile.FirstName" For="() => _userProfile.FirstName"
                            Label="Fornavn" Variant="Variant.Outlined" name="name" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="@_userProfile.LastName" For="() => _userProfile.LastName"
                            Label="Efternavn" Variant="Variant.Outlined" name="lastname" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudDatePicker AdornmentColor="Color.Info" @bind-Date="@_userProfile.DateOfBirth"
                            Color="Color.Info" For="() => _userProfile.DateOfBirth" Label="Fødselsdato"
                            OpenTo="OpenTo.Year" PickerVariant="PickerVariant.Dialog"
                            Placeholder="@DateTime.Now.ToString("d")" Variant="Variant.Outlined" Rounded
                            autocomplete="bday" />
                    </MudItem>
                </MudGrid>
            </MudPaper>

            @* Location Section *@
            <MudPaper Elevation="3" Class="pa-6 mb-4">
                <MudText Typo="Typo.h4" Class="mb-6"
                    Style="@($"color: {JordnaerPalette.BlueBody}; font-family: 'Cherry Bomb One', cursive; letter-spacing: 0.11em;")">
                    Lokation
                </MudText>

                <MudGrid Spacing="3">

                    @* Location input - smaller on desktop *@
                    <MudItem xs="12" md="8" lg="6">
                        @if (_useZipCodeOnly)
                        {
                            <ZipCodeAutoComplete Location="@_zipCodeLocation" LocationChanged="OnZipCodeLocationChanged"
                                For="() => _zipCodeLocation" DisableSmartCompletion="true" />
                        }
                        else
                        {
                            <AddressAutoComplete Address="@_addressLocation" AddressChanged="OnAddressLocationChanged"
                                For="() => _addressLocation" />
                        }
                    </MudItem>

                    @* Privacy toggle - aligned with input on desktop *@
                    <MudItem xs="12" md="4" lg="6" Class="d-flex align-center text-center justify-content-center">
                        <MudTooltip
                            Text="Klik for at skifte mellem fuld adresse og kun postnummer. Postnummer er mere privat, men mindre præcist.">
                            <MudChip T="string" Size="Size.Large" Color="@(_useZipCodeOnly? Color.Default: Color.Info)"
                                Variant="Variant.Outlined" OnClick="@ToggleLocationMode" Style="cursor: pointer;">
                                @if (_useZipCodeOnly)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Small" Class="mr-1" />
                                    <span>Kun postnummer</span>
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                    <span>Fuld adresse</span>
                                }
                            </MudChip>
                        </MudTooltip>
                    </MudItem>


                    @* Privacy Notice - show first for context *@
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense Class="pa-3">
                            Din adresse vises aldrig offentligt. Andre ser kun omtrentlig afstand (f.eks. "5 km væk").
                        </MudAlert>
                    </MudItem>

                </MudGrid>
            </MudPaper>

            @* Interests & Description Section *@
            <MudPaper Elevation="3" Class="pa-6 mb-4">
                <MudText Typo="Typo.h4" Class="mb-6"
                    Style="@($"color: {JordnaerPalette.RedHeader}; font-family: 'Cherry Bomb One', cursive; letter-spacing: 0.11em;")">
                    Interesser
                </MudText>

                <MudGrid Spacing="3">
                    <MudItem xs="12">
                        <MudText Typo="Typo.body1" Class="mb-2">Interesseret i</MudText>
                        <CategorySelector @bind-Categories="_selectedCategoryNames" />
                    </MudItem>

                    <MudItem xs="12">
                        <TextEditorComponent
                            Placeholder="Du kan f.eks fortælle om dine interesser, uddannelse, familie, børnesyn, værdier og den slags."
                            Label="Beskrivelse" Text="@_userProfile.Description" @ref="_textEditorComponent" />
                    </MudItem>
                </MudGrid>
            </MudPaper>

            @* Save Button 1*@
            <div class="d-flex justify-center mb-6">
                <MudButton Size="Size.Large" StartIcon="@Icons.Material.Filled.Save" ButtonType="ButtonType.Submit"
                    Variant="Variant.Filled"
                    Style="@($"min-width: 300px; height: 48px; background-color: {JordnaerPalette.GreenBackground}; color: white;")">
                    Gem ændringer
                </MudButton>
            </div>

            <MiniDivider Color="MiniDividerColor.Blue" Center Class="my-6" />

            @* Children Section *@
            <MudPaper Elevation="3" Class="pa-6 mb-6">
                <MudText Typo="Typo.h4" Class="mb-6"
                    Style="@($"color: {JordnaerPalette.BlueBody}; font-family: 'Cherry Bomb One', cursive; letter-spacing: 0.11em;")">
                    Børn
                </MudText>
                <EditChildProfileTabs @bind-Parent="_userProfile" @ref="_editChildProfileTabsComponent">
                </EditChildProfileTabs>
            </MudPaper>

            @* Save Button 2 *@
            <div class="d-flex justify-center mb-6">
                <MudButton Size="Size.Large" StartIcon="@Icons.Material.Filled.Save" ButtonType="ButtonType.Submit"
                    Variant="Variant.Filled"
                    Style="@($"min-width: 300px; height: 48px; background-color: {JordnaerPalette.GreenBackground}; color: white;")">
                    Gem ændringer
                </MudButton>
            </div>
        </EditForm>

    </MudContainer>
</MudLoading>
@code {
    private bool _isLoading = true;
    private UserProfile? _userProfile;
    private IEnumerable<Category> _categories = Enumerable.Empty<Category>();

    private TextEditorComponent _textEditorComponent = default!;

    private bool _useZipCodeOnly = false;
    private string _zipCodeLocation = string.Empty;
    private string _addressLocation = string.Empty;
    private string[]? _selectedCategoryNames;

    protected override async Task OnInitializedAsync()
    {
        if (!RendererInfo.IsInteractive)
        {
            return;
        }

        var userProfile = await ProfileCache.GetProfileAsync();
        if (userProfile is null)
        {
            Snackbar.Add(ErrorMessages.Something_Went_Wrong_Refresh,
            Severity.Warning);
            _isLoading = false;
            return;
        }

        _userProfile = userProfile;

        // Initialize location fields from existing data
        if (_userProfile.Address is not null)
        {
            _addressLocation = _userProfile.Address;
            _useZipCodeOnly = false;
        }
        else if (_userProfile.ZipCode is not null && _userProfile.City is not null)
        {
            _zipCodeLocation = $"{_userProfile.ZipCode} {_userProfile.City}";
            _useZipCodeOnly = true;
        }

        _categories = await CategoryCache.GetOrCreateCategoriesAsync();

        // Initialize selected category names
        _selectedCategoryNames = _userProfile.Categories.Select(c => c.Name).ToArray();

        _isLoading = false;
    }

    private async Task OnAddressLocationChanged(string address)
    {
        _addressLocation = address;

        if (string.IsNullOrWhiteSpace(address))
        {
            _userProfile!.Address = null;
            _userProfile.ZipCode = null;
            _userProfile.City = null;
            _userProfile.Location = null;
            return;
        }

        var result = await LocationService.GetLocationFromAddressAsync(address);
        if (result is not null)
        {
            _userProfile!.Address = address;
            _userProfile.ZipCode = result.ZipCode;
            _userProfile.City = result.City;
            _userProfile.Location = result.Location;
        }
        else
        {
            Snackbar.Add("Kunne ikke hente lokationsdata. Prøv venligst igen om et par minutter.",
            Severity.Warning);
        }
    }

    private async Task OnZipCodeLocationChanged(string zipCode)
    {
        _zipCodeLocation = zipCode;

        if (string.IsNullOrWhiteSpace(zipCode))
        {
            _userProfile!.Address = null;
            _userProfile.ZipCode = null;
            _userProfile.City = null;
            _userProfile.Location = null;
            return;
        }

        var result = await LocationService.GetLocationFromZipCodeAsync(zipCode);
        if (result is not null)
        {
            _userProfile!.Address = null; // Don't store address when using zip code only
            _userProfile.ZipCode = result.ZipCode;
            _userProfile.City = result.City;
            _userProfile.Location = result.Location;
        }
        else
        {
            Snackbar.Add("Kunne ikke hente lokationsdata. Prøv venligst igen om et par minutter.",
            Severity.Warning);
        }
    }

    private async Task UpdateUserProfile()
    {
        _isLoading = true;

        if (_userProfile is null)
        {
            Snackbar.Add(ErrorMessages.Something_Went_Wrong_Try_Again, Severity.Error);
            _isLoading = false;
            return;
        }

        // Sync selected categories back to user profile
        _userProfile.Categories = _categories
        .Where(c => _selectedCategoryNames != null && _selectedCategoryNames.Contains(c.Name))
        .ToList();

        _userProfile.Description = await _textEditorComponent.GetHtmlAsync();
        await _editChildProfileTabsComponent.UpdateChildProfileDescriptions();

        var updateProfileResult = await ProfileService.UpdateUserProfile(_userProfile);
        updateProfileResult.Switch(
        success =>
        {
            Snackbar.Add("Din profil er blevet opdateret!", Severity.Success);
            ProfileCache.SetProfile(success.Value);
        },
        _ => Snackbar.Add(ErrorMessages.Something_Went_Wrong_Try_Again, Severity.Error));

        _isLoading = false;
    }

    private void ToggleLocationMode()
    {
        _useZipCodeOnly = !_useZipCodeOnly;
    }

    private EditChildProfileTabs _editChildProfileTabsComponent = default!;
}